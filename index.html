<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limbus Company Draft System - Multiplayer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #8B0000;
            --primary-dark: #5a0000;
            --secondary: #4A0000;
            --accent: #FFD700;
            --text: #F0F0F0;
            --bg: #1a1a1d;
            --panel: #1E1E1E;
            --border: #333;
            --rarity-0: #cccccc;
            --rarity-00: #B22222;
            --rarity-000: #FFD700;
            --sin-wrath-bg: rgba(129,44,33,255);
            --sin-lust-bg: rgba(177,97,46,255);
            --sin-sloth-bg: rgba(226,136,3,255);
            --sin-gluttony-bg: rgba(226,136,3,255);
            --sin-gloom-bg: rgba(45,102,116,255);
            --sin-pride-bg: rgba(22,81,131,255);
            --sin-envy-bg: rgba(22,81,131,255);
            --connected: #4b8b3b;
            --disconnected: #a00;
            --warning: #ff8c00;
            --ready: #4b8b3b;
            --drafting: #4169e1;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .hidden {
            display: none !important;
        }
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-size: 3.2rem;
            margin-bottom: 10px;
            color: var(--accent);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(to right, var(--accent), #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }
        
        h2 {
            font-size: 2rem;
            margin: 15px 0;
            color: var(--accent);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
            text-align: center;
        }
        
        h3 {
            font-size: 1.4rem;
            color: var(--accent);
            margin-bottom: 15px;
        }
        
        h4 {
            font-size: 1.1rem;
            color: #ccc;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .card {
            background: rgba(30, 30, 30, 0.85);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--border);
            backdrop-filter: blur(5px);
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .btn:hover {
            background: #a00;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .btn-primary {
            background: var(--accent);
            color: #000;
        }
        
        .btn-primary:hover {
            background: #ffc400;
        }

        .btn-secondary {
            background: #444;
            color: #fff;
        }
        .btn-secondary:hover {
            background: #555;
        }
        
        .btn-large {
            padding: 18px 35px;
            font-size: 1.3rem;
        }
        
        #main-page {
            text-align: center;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }
        
        .logo {
            width: 180px;
            height: 180px;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
        }
        
        .logo i {
            font-size: 7rem;
            color: #000;
        }
        
        .welcome-text {
            font-size: 1.2rem;
            line-height: 1.8;
            margin-bottom: 40px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .action-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin: 40px 0;
        }
        
        .action-card {
            flex: 1;
            min-width: 300px;
            max-width: 350px;
            background: rgba(74, 0, 0, 0.5);
            border-radius: 15px;
            padding: 30px;
            border-top: 4px solid var(--accent);
            display: flex;
            flex-direction: column;
            gap: 20px;
            transition: transform 0.3s;
        }
        
        .action-card:hover {
            transform: translateY(-10px);
        }
        
        .action-icon {
            font-size: 3.5rem;
            color: var(--accent);
        }
        
        .action-title {
            font-size: 1.8rem;
            color: var(--accent);
        }
        
        .action-description {
            font-size: 1.1rem;
            line-height: 1.6;
            flex-grow: 1;
        }
        
        .lobby-access {
            background: rgba(74, 0, 0, 0.6);
            border-radius: 15px;
            padding: 30px;
            margin: 40px auto;
            max-width: 600px;
            border: 1px solid var(--accent);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
        }
        
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 1.1rem;
            color: var(--accent);
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 1.1rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }
        
        .role-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .role-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .role-option.selected {
            background: var(--primary);
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .btn-ready {
            background: var(--ready) !important;
            color: white !important;
        }

        .status-ready {
            background: var(--ready) !important;
        }
        .lobby-info > div {
            flex: 1;
            text-align: center;
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-top: 10px;
        }
        
        .player-panel.draft-active {
            box-shadow: 0 0 15px var(--accent);
            border: 2px solid var(--accent);
            transform: scale(1.02);
        }
        .role-option i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--accent);
        }
        
        .participant.current-user {
            background: var(--primary-dark);
            border: 2px solid var(--accent);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        #lobby-view, #roster-builder-page {
            display: none;
        }
        
        .lobby-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--accent);
        }
        
        .lobby-info::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--primary));
        }
        
        .code-display {
            font-family: monospace;
            font-size: 2rem;
            letter-spacing: 6px;
            padding: 12px 25px;
            background: #000;
            border-radius: 8px;
            color: var(--accent);
            border: 1px solid var(--accent);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }
        
        .participants {
            display: flex;
            gap: 20px;
            font-size: 1.2rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .participant {
            background: var(--primary);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .participant:hover {
            transform: translateY(-5px);
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }
        
        .phase-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .phase-section {
            flex: 1;
            min-width: 300px;
        }
        
        .player-section {
            flex: 1;
            min-width: 300px;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        
        .player-area {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .player-panel {
            flex: 1;
            min-width: 280px;
            background: var(--secondary);
            border-radius: 10px;
            padding: 15px;
            border-top: 4px solid var(--accent);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .player-panel.locked::after {
            content: 'LOCKED';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--accent);
            font-weight: bold;
            z-index: 5;
            border-radius: 10px;
            backdrop-filter: blur(2px);
        }


        .controls {
            display: flex;
            justify-content: space-around; 
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .player-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--accent);
        }
        
        .player-status {
            background: var(--primary);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .ban-list, .pick-list {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            min-height: 100px;
            max-height: 250px; 
            overflow-y: auto;
            align-content: start;
        }

        .id-item {
            padding: 8px;
            margin: 0;
            background: rgba(139, 0, 0, 0.3);
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s, border-color 0.3s;
            border-left: 4px solid transparent; 
        }
        
        .id-item.rarity-0 { border-left-color: var(--rarity-0); }
        .id-item.rarity-00 { border-left-color: var(--rarity-00); }
        .id-item.rarity-000 { border-left-color: var(--rarity-000); }

        .id-item:hover {
            background: rgba(139, 0, 0, 0.5);
            transform: translateX(5px);
        }
        
        .id-item.selected {
            background: var(--primary);
            border-color: var(--accent) !important;
            box-shadow: 0 0 10px var(--accent);
        }
        
        .id-icon {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
            border: 1px solid var(--border);
        }

        .id-name {
            flex-grow: 1;
            font-size: 0.95rem;
            font-weight: 500;
            min-height: 2.5em; 
            display: flex;
            align-items: center;
            line-height: 1.25; 
        }
        
        .roster-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .counter {
            text-align: center;
            margin: 10px 0;
            font-size: 1.1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .counter strong {
            color: var(--accent);
            font-size: 1.3rem;
        }
        
        .roster-complete {
            background: rgba(0, 100, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            border: 1px solid rgba(0, 200, 0, 0.3);
        }
        
        .status-ready { background: var(--ready) !important; color: #fff !important; }
        .status-drafting { background: var(--drafting) !important; color: #fff !important; }
        .status-waiting { background: #a0a0a0 !important; color: #fff !important; }
        
        #draft-status-panel {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--accent);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        #current-phase { font-size: 1.5rem; margin-bottom: 10px; }
        #draft-action-description { font-size: 1.1rem; color: var(--text); min-height: 24px; }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            background: var(--disconnected);
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            background: var(--primary);
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(-50%) translateY(10px);
        }
        
        #completed-view { text-align: center; display: none; }

        .final-rosters-container {
            display: flex;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .final-player-panel {
            flex: 1;
            min-width: 400px;
            max-width: 800px; /* Increased max-width for columns */
            background: var(--panel);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--border);
            border-top: 4px solid var(--primary);
        }

        .final-player-panel h2 { font-size: 1.8rem; }
        .final-player-panel h3 {
            font-size: 1.2rem;
            margin-top: 20px;
            color: #ccc;
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }

        .final-picks-grid {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .final-picks-col {
            flex: 1;
        }
        .final-bans {
             margin-top: 15px;
        }

        .final-bans .id-item { background: rgba(100, 0, 0, 0.4); opacity: 0.8; }
        .final-bans .id-name { text-decoration: line-through; color: #f0f0f0; }
        #restart-draft { margin: 20px auto; }
        
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #ccc; }

        /* EGO BANNING STYLES */
        #ego-ban-phase { width: 100%; }

        .ego-ban-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        #ego-ban-phase.p1-banning #ego-selection-window { order: 1; }
        #ego-ban-phase.p1-banning #opponent-roster-display { order: 2; }
        #ego-ban-phase.p2-banning #ego-selection-window { order: 2; }
        #ego-ban-phase.p2-banning #opponent-roster-display { order: 1; }

        #ego-selection-window, #opponent-roster-display {
            flex: 1;
            background: var(--panel);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .ego-ban-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            max-height: 75vh; 
            overflow-y: auto;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        
        .ego-item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            color: #111;
        }

        .ego-item:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }

        .ego-item.banned {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #333 !important;
            color: #999;
        }
        
        .ego-item.banned-p1 { border: 2px dashed var(--primary); }
        .ego-item.banned-p2 { border: 2px dashed var(--drafting); }

        .ego-header {
            display: flex;
            justify-content: flex-end;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .ego-rarity {
            padding: 2px 6px;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.2);
            color: #fff;
        }

        .ego-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
            flex-grow: 1;
        }

        .banned-egos-display {
            background: var(--panel);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid var(--border);
        }

        .banned-egos-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        
        .banned-ego-item {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            text-align: center;
            color: #111;
        }
        .banned-ego-item .rarity {
            font-weight: bold;
            margin-right: 5px;
            background: rgba(0,0,0,0.2);
            padding: 2px 4px;
            border-radius: 3px;
            color: #fff;
        }
         .banned-ego-item .name { text-decoration: line-through; }

        /* Roster Builder Styles */
        #roster-builder-page .card {
            display: flex;
            flex-direction: column; /* Default to stacked layout */
            gap: 20px;
        }
        
        .builder-content-wrapper {
            display: flex;
            flex-direction: column; /* Stack panels by default */
            gap: 20px;
        }

        .builder-sinner-nav {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .sinner-nav-btn {
            padding: 6px 10px; /* Reduced vertical padding */
            font-size: 0.9rem; /* Reduced font size */
            flex-grow: 1; /* Allow buttons to grow and fill space */
            text-align: center;
            background: var(--secondary);
            border: 1px solid var(--border);
        }

        .sinner-nav-btn.selected {
            background: var(--primary);
            color: var(--accent);
            border-bottom: 4px solid var(--accent);
            border-left: 1px solid var(--border);
        }

        .builder-main-panel { 
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
        }
        .builder-side-panel { 
            background: var(--secondary); 
            padding: 20px; 
            border-radius: 10px; 
            align-self: stretch;
        }
        
        .builder-id-pool {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
            max-height: 70vh;
            overflow-y: auto;
            padding: 10px;
        }
        
        #builder-roster-code {
            word-wrap: break-word;
            background: #111;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            min-height: 50px;
            margin-top: 10px;
        }
        .roster-code-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .roster-code-actions input { flex-grow: 1; }
        .roster-code-actions .btn { padding: 14px; }
        
        .roster-load-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        /* NEW: Universal Grouped Roster View Styles */
        .sinner-grouped-roster {
            display: flex;
            flex-direction: column;
            gap: 5px; /* Tighter space between sinner rows */
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .sinner-grouped-roster .sinner-row { }
        .sinner-grouped-roster .sinner-header {
            height: 0;
            border-bottom: 1px solid var(--border);
            margin: 4px 0; /* Reduced margin */
            padding: 0;
        }
        .sinner-grouped-roster .sinner-id-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        /* Style the id-item when it's inside the new container */
        .sinner-grouped-roster .id-item {
            padding: 2px;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 5px;
            gap: 0;
        }
        .sinner-grouped-roster .id-item .id-name {
            display: none; /* Hide the name */
        }
        .sinner-grouped-roster .id-item .id-icon {
            width: 70px; /* Increased size */
            height: 70px; /* Increased size */
        }
        .sinner-grouped-roster .id-item:hover {
            transform: scale(1.1);
            border-color: var(--accent);
            z-index: 2;
            background: var(--primary-dark);
        }
        .sinner-grouped-roster .id-item.selected {
            border-color: var(--accent) !important;
            box-shadow: 0 0 8px var(--accent);
            background: var(--primary);
        }

        /* Medium screens and up */
        @media (min-width: 992px) {
            #roster-builder-page .card {
                flex-direction: row;
            }
            .builder-sinner-nav {
                flex-direction: column;
                flex-wrap: nowrap;
                flex: 0 0 130px; /* Fixed width for the sinner nav */
                gap: 4px; /* Reduced gap */
            }
            .sinner-nav-btn {
                text-align: left;
            }
            .sinner-nav-btn.selected {
                 border-bottom: 1px solid var(--border);
                 border-left: 4px solid var(--accent);
            }
            .builder-content-wrapper {
                flex: 1;
                display: flex;
                flex-direction: row;
            }
            .builder-main-panel { 
                flex: 2; 
                min-width: 350px; 
            }
            .builder-side-panel { 
                flex: 1;
                min-width: 280px; 
            }
        }
        
        /* Large screens */
        @media (min-width: 1400px) {
            .builder-side-panel {
                flex: 1.2;
            }
        }

        @media (max-width: 768px) {
            .container { max-width: 100%; }
            .action-container { flex-direction: column; align-items: center; }
            .action-card, .final-player-panel { min-width: 100%; }
            .lobby-info { flex-direction: column; gap: 20px; }
            h1 { font-size: 2.5rem; }
            .code-display { font-size: 1.5rem; letter-spacing: 4px; }
            .role-options { flex-direction: column; }
            .phase-container { flex-direction: column; }
            .connection-status { top: 5px; right: 5px; font-size: 0.8rem; padding: 5px 10px; }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connection-status">
        <i class="fas fa-plug"></i>
        <span>Connecting...</span>
    </div>
 
    <div class="notification" id="notification">Player joined the lobby!</div>

    <div class="container">
        <div id="main-page">
            <header>
                <h1><i class="fas fa-dragon"></i> Limbus Company Draft System</h1>
                <p>Organize and participate in competitive drafting sessions</p>
            </header>

            <div class="logo">
                <i class="fas fa-dragon"></i>
            </div>
            
            <div class="welcome-text">
                <p>Welcome to the official Limbus Company drafting system. Here you can create or join lobbies to organize competitive matches with other players, or use the Roster Builder to prepare your teams in advance.</p>
            </div>
            
            <div class="form-group" style="max-width: 400px; margin: 30px auto; text-align: left;">
                <label for="player-name">Your Display Name</label>
                <input type="text" id="player-name" placeholder="Enter your name">
            </div>
            
            <div class="action-container">
                <div class="action-card">
                    <div class="action-icon"><i class="fas fa-users-cog"></i></div>
                    <h3 class="action-title">Roster Builder</h3>
                    <p class="action-description">Create a 42-ID roster and generate a shareable code for quick loading during a match.</p>
                    <button class="btn btn-secondary btn-large" id="go-to-builder"><i class="fas fa-wrench"></i> Open Builder</button>
                </div>

                <div class="action-card">
                    <div class="action-icon"><i class="fas fa-plus-circle"></i></div>
                    <h3 class="action-title">Create New Lobby</h3>
                    <p class="action-description">Start a new drafting session as the referee. You'll get a unique lobby code to share with players.</p>
                    <button class="btn btn-primary btn-large" id="create-lobby"><i class="fas fa-plus"></i> Create Lobby</button>
                </div>
                
                <div class="action-card">
                    <div class="action-icon"><i class="fas fa-sign-in-alt"></i></div>
                    <h3 class="action-title">Join Existing Lobby</h3>
                    <p class="action-description">Join a lobby using a code provided by the referee. Select your role before entering.</p>
                    <button class="btn btn-large" id="join-lobby"><i class="fas fa-door-open"></i> Join Lobby</button>
                </div>
            </div>
            
            <div class="lobby-access" id="lobby-access-form" style="display: none;">
                <h2>Enter Lobby Details</h2>
                <div class="form-group">
                    <label for="lobby-code">Lobby Code:</label>
                    <input type="text" id="lobby-code" placeholder="Enter 6-character code" maxlength="6">
                </div>
                <div class="form-group">
                    <label>Select Your Role:</label>
                    <div class="role-options">
                        <div class="role-option" data-role="p1"><i class="fas fa-user"></i><div>Player 1</div></div>
                        <div class="role-option" data-role="p2"><i class="fas fa-user"></i><div>Player 2</div></div>
                        <div class="role-option" data-role="ref"><i class="fas fa-star"></i><div>Referee</div></div>
                    </div>
                </div>
                <button class="btn btn-primary btn-large" id="enter-lobby"><i class="fas fa-play"></i> Enter Lobby</button>
            </div>
        </div>
        
        <div id="lobby-view">
            <button class="btn back-button" id="back-to-main-lobby"><i class="fas fa-arrow-left"></i> Main Menu</button>
            
            <header>
                <h1><i class="fas fa-dragon"></i> Limbus Company Draft System</h1>
                <p>Drafting session in progress</p>
            </header>
            
            <div class="card">
                <div class="lobby-info">
                    <div>
                        <h3>LOBBY CODE</h3>
                        <div class="code-display" id="lobby-code-display"></div>
                        <p>Share this code with other participants</p>
                    </div>
                    <div>
                        <h3>PHASE TIMER</h3>
                        <div class="timer" id="phase-timer">--:--</div>
                    </div>
                    <div>
                        <h3>PARTICIPANTS</h3>
                        <div class="participants" id="participants-list"></div>
                    </div>
                </div>
                
                <div id="draft-status-panel">
                    <h3 id="current-phase">Waiting for draft to start...</h3>
                    <p id="draft-action-description"></p>
                </div>

                <!-- Roster Selection Phase -->
                <div id="roster-phase" class="phase-section">
                    <h2>Roster Selection Phase</h2>
                    <p>Each player must select 42 IDs. When both are ready, the Referee can start the EGO Ban phase.</p>
                    <div class="filter-bar" id="global-filter-bar-roster">
                        <!-- Filters are now globally defined and rendered by JS -->
                    </div>
                    <div class="player-area">
                        <div class="player-panel" id="p1-panel">
                            <div class="player-header">
                                <div class="player-name" id="p1-name-display">Player 1</div>
                                <div class="player-status status-waiting" id="p1-status">Selecting</div>
                            </div>
                            <div class="counter"><i class="fas fa-users"></i> Selected: <strong id="p1-counter">0</strong> / 42 IDs</div>
                            <div class="roster-load-form">
                                <input type="text" id="p1-roster-code-input" placeholder="Paste Roster Code...">
                                <button class="btn btn-secondary" id="p1-roster-load"><i class="fas fa-upload"></i> Load</button>
                            </div>
                            <div class="roster-selection" id="p1-roster"></div>
                            <div class="controls">
                                <button class="btn" id="p1-random"><i class="fas fa-random"></i> Randomize</button>
                                <button class="btn" id="p1-clear"><i class="fas fa-trash"></i> Clear</button>
                                <button class="btn" id="p1-ready"><i class="fas fa-check"></i> Ready</button>
                            </div>
                        </div>
                        <div class="player-panel" id="p2-panel">
                            <div class="player-header">
                                <div class="player-name" id="p2-name-display">Player 2</div>
                                <div class="player-status status-waiting" id="p2-status">Selecting</div>
                            </div>
                            <div class="counter"><i class="fas fa-users"></i> Selected: <strong id="p2-counter">0</strong> / 42 IDs</div>
                            <div class="roster-load-form">
                                <input type="text" id="p2-roster-code-input" placeholder="Paste Roster Code...">
                                <button class="btn btn-secondary" id="p2-roster-load"><i class="fas fa-upload"></i> Load</button>
                            </div>
                            <div class="roster-selection" id="p2-roster"></div>
                            <div class="controls">
                                <button class="btn" id="p2-random"><i class="fas fa-random"></i> Randomize</button>
                                <button class="btn" id="p2-clear"><i class="fas fa-trash"></i> Clear</button>
                                <button class="btn" id="p2-ready"><i class="fas fa-check"></i> Ready</button>
                            </div>
                        </div>
                    </div>
                    <div class="ref-actions" style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary btn-large" id="start-ego-ban" disabled><i class="fas fa-ban"></i> Start EGO Bans</button>
                    </div>
                </div>

                <!-- EGO Ban Phase -->
                <div id="ego-ban-phase" class="phase-section hidden">
                    <h2>EGO Ban Phase</h2>
                    <div class="ego-ban-layout">
                        <div id="ego-selection-window">
                            <h3>Available EGOs</h3>
                            <div class="filter-bar">
                                <div class="filter-group" style="flex-grow: 2;">
                                    <label class="filter-label" for="ego-search-input">Search EGOs:</label>
                                    <input type="text" id="ego-search-input" placeholder="Search by name or sinner...">
                                </div>
                            </div>
                            <div class="ego-ban-container" id="ego-ban-container"></div>
                        </div>
                        <div id="opponent-roster-display">
                            <h3 id="opponent-roster-title">Opponent's Roster</h3>
                            <div class="roster-selection" id="opponent-roster-list"></div>
                        </div>
                    </div>
                    <div class="controls" style="margin-top: 20px;">
                        <button class="btn btn-primary" id="confirm-ego-bans" disabled><i class="fas fa-check-double"></i> Confirm Bans</button>
                    </div>
                </div>

                <!-- ID Draft Phase -->
                <div id="id-draft-phase" class="player-section hidden">
                    <h2>ID Draft Phase</h2>
                    <div class="banned-egos-display" id="draft-banned-egos">
                        <h3><i class="fas fa-ban"></i> Banned EGOs</h3>
                        <div class="banned-egos-list" id="draft-banned-egos-list"></div>
                    </div>
                    <div class="filter-bar" id="global-filter-bar-draft">
                        <!-- Filters for draft phase rendered here by JS -->
                    </div>
                    <div class="player-area">
                         <div class="player-panel" id="p1-draft-panel">
                            <div class="player-header">
                                <div class="player-name" id="p1-draft-name">Player 1</div>
                                <div class="player-status status-waiting" id="p1-draft-status">Waiting</div>
                            </div>
                            <div class="roster-selection" id="p1-draft-selection"></div>
                            <h4>Your Bans:</h4><div class="ban-list" id="p1-id-bans"></div>
                            <h4>Picked IDs:</h4><div class="pick-list" id="p1-picks"></div>
                        </div>
                        <div class="player-panel" id="p2-draft-panel">
                            <div class="player-header">
                                <div class="player-name" id="p2-draft-name">Player 2</div>
                                <div class="player-status status-waiting" id="p2-draft-status">Waiting</div>
                            </div>
                            <div class="roster-selection" id="p2-draft-selection"></div>
                            <h4>Your Bans:</h4><div class="ban-list" id="p2-id-bans"></div>
                            <h4>Picked IDs:</h4><div class="pick-list" id="p2-picks"></div>
                        </div>
                    </div>
                    <div class="ref-actions" style="text-align: center; margin-top: 20px;">
                        <button class="btn hidden" id="next-phase" disabled><i class="fas fa-step-forward"></i> Next Phase</button>
                        <button class="btn btn-primary" id="complete-draft" disabled><i class="fas fa-flag-checkered"></i> Complete Draft</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roster Builder Page -->
        <div id="roster-builder-page">
            <button class="btn back-button" id="back-to-main-builder"><i class="fas fa-arrow-left"></i> Main Menu</button>
            <header>
                <h1><i class="fas fa-users-cog"></i> Roster Builder</h1>
                <p>Create a roster and generate a shareable code.</p>
            </header>
            <div class="card">
                <div class="builder-sinner-nav" id="builder-sinner-nav">
                    <!-- Sinner buttons will be rendered here -->
                </div>
                <div class="builder-content-wrapper">
                    <div class="builder-main-panel">
                        <h3>Available Identities</h3>
                         <div class="filter-bar" id="global-filter-bar-builder"></div>
                         <div class="builder-id-pool" id="builder-id-pool">
                             <!-- Sinner IDs will be rendered here -->
                         </div>
                    </div>
                    <div class="builder-side-panel">
                        <h3>Your Roster (<span id="builder-counter">0</span>/42)</h3>
                        <div class="roster-selection" id="builder-selected-roster"></div>
                        <div class="controls" style="margin-top: 10px;">
                            <button class="btn" id="builder-random"><i class="fas fa-random"></i> Random</button>
                            <button class="btn" id="builder-clear"><i class="fas fa-trash"></i> Clear</button>
                        </div>
                        <h3 style="margin-top: 20px;">Roster Code</h3>
                        <p>Use this code to quickly load your roster here or in a match lobby.</p>
                        <div id="builder-roster-code-display" style="background: #111; padding: 10px; border-radius: 5px; font-family: monospace; min-height: 50px; margin-top: 10px; word-wrap: break-word;">
                            Select 42 IDs to generate a code.
                        </div>
                        <button class="btn btn-primary" id="builder-copy-code" style="width: 100%; margin-top: 10px;" disabled><i class="fas fa-copy"></i> Copy Code</button>
                        
                        <h3 style="margin-top: 20px;">Load from Code</h3>
                        <div class="roster-code-actions">
                            <input type="text" id="builder-load-code-input" placeholder="Paste code here...">
                            <button class="btn" id="builder-load-code"><i class="fas fa-upload"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Draft View -->
        <div id="completed-view" style="display: none;">
            <header>
                <h1><i class="fas fa-flag-checkered"></i> Draft Complete</h1>
                <p>Final Rosters</p>
            </header>
            <div class="banned-egos-display" id="final-banned-egos">
                <h3><i class="fas fa-ban"></i> Banned EGOs</h3>
                <div class="banned-egos-list" id="final-banned-egos-list"></div>
            </div>
            <div class="final-rosters-container">
                <div class="final-player-panel">
                    <h2 id="final-p1-name">Player 1's Roster</h2>
                    <div class="final-picks-grid">
                        <div class="final-picks-col" id="final-p1-picks-col1"></div>
                        <div class="final-picks-col" id="final-p1-picks-col2"></div>
                    </div>
                    <h3>Banned from Roster</h3>
                    <div class="final-bans" id="final-p1-bans"></div>
                </div>
                <div class="final-player-panel">
                    <h2 id="final-p2-name">Player 2's Roster</h2>
                    <div class="final-picks-grid">
                        <div class="final-picks-col" id="final-p2-picks-col1"></div>
                        <div class="final-picks-col" id="final-p2-picks-col2"></div>
                    </div>
                    <h3>Banned from Roster</h3>
                    <div class="final-bans" id="final-p2-bans"></div>
                </div>
            </div>
            <button class="btn btn-large btn-primary" id="restart-draft"><i class="fas fa-redo"></i> Start New Draft</button>
        </div>
    </div>

    <script>
        // ======================
        // CONSTANTS & CONFIG
        // ======================
        const ROSTER_SIZE = 42;
        const EGO_BAN_COUNT = 5;
        
        // ======================
        // APPLICATION STATE
        // ======================
        const state = {
            currentView: "main",
            lobbyCode: "",
            userId: generateUserId(),
            userRole: "",
            participants: {
                p1: { name: "Player 1", status: "disconnected", ready: false },
                p2: { name: "Player 2", status: "disconnected", ready: false },
                ref: { name: "Referee", status: "disconnected" }
            },
            roster: { p1: [], p2: [] },
            builderRoster: [],
            masterIDList: [],
            masterEGOList: [],
            idsBySinner: null, // Will be populated on init
            builderSelectedSinner: "Yi Sang", // Default sinner to show
            draft: {
                phase: "roster",
                step: 0,
                currentPlayer: "",
                action: "",
                actionCount: 0,
                available: { p1: [], p2: [] },
                idBans: { p1: [], p2: [] },
                egoBans: { p1: [], p2: [] },
                picks: { p1: [], p2: [] }
            },
            filters: { sinner: "", sinAffinity: "", keyword: "", rosterSearch: "" },
            draftFilters: { sinner: "", sinAffinity: "", keyword: "", rosterSearch: "" },
            egoSearch: "",
            timer: 0,
            timerInterval: null,
            serverType: "remote",
            socket: null,
        };

        let elements = {};

        // ======================
        // UTILITY & CORE
        // ======================
        function generateUserId() {
            return 'user-' + Math.random().toString(36).substr(2, 9);
        }
        
        function showNotification(text, isError = false) {
            elements.notification.textContent = text;
            elements.notification.style.background = isError ? 'var(--disconnected)' : 'var(--primary)';
            elements.notification.classList.add('show');
            setTimeout(() => { elements.notification.classList.remove('show'); }, 3000);
        }

        function createSlug(name) {
            if (!name) return '';
            let slug = name.toLowerCase();
            slug = slug.replace(/ryōshū/g, 'ryshu').replace(/öufi/g, 'ufi');
            slug = slug.replace(/e\.g\.o::/g, 'ego-');
            slug = slug.replace(/ & /g, ' ').replace(/[.'"]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/[^\w-]+/g, '');
            return slug;
        }
        
        // ======================
        // DATA HANDLING
        // ======================
        function parseIDCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return [];
            const regex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;
            const headers = lines[0].split(',').map(h => h.trim());
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = line.match(regex) || [];
                if (values.length !== headers.length) continue;
                const obj = {};
                headers.forEach((header, idx) => {
                    let value = values[idx].trim();
                    if (value.startsWith('"') && value.endsWith('"')) value = value.slice(1, -1);
                    obj[header] = value;
                });

                const name = obj.Name;
                const sinnerMatch = name.match(/(Yi Sang|Faust|Don Quixote|Ryōshū|Meursault|Hong Lu|Heathcliff|Ishmael|Rodion|Sinclair|Outis|Gregor)/);
                
                result.push({
                    id: createSlug(name), 
                    name: name,
                    keywords: obj.Keywords ? obj.Keywords.split(',').map(k => k.trim()) : [],
                    sinAffinities: obj.SinAffinities ? obj.SinAffinities.split(',').map(s => s.trim()) : [],
                    rarity: obj.Rarity,
                    imageFile: `${createSlug(name)}.webp`, 
                    sinner: sinnerMatch ? sinnerMatch[0] : "Unknown",
                });
            }
            return result;
        }

        function parseEGOData(data) {
            const lines = data.trim().split('\n');
            const egoList = [];
            const bgColorMap = { 
                'Yellow': 'var(--sin-sloth-bg)', 'Blue': 'var(--sin-gloom-bg)', 'Red': 'var(--sin-wrath-bg)',
                'Indigo': 'var(--sin-pride-bg)', 'Purple': 'var(--sin-envy-bg)', 'Orange': 'var(--sin-lust-bg)',
                'Green': 'var(--sin-gluttony-bg)'
            };
            
            lines.forEach(line => {
                if (!line.includes(' - ')) return;
                const parts = line.split(' - ');
                if (parts.length < 4) return;

                const nameAndSinner = parts[0];
                const rarity = parts[1].trim();
                const sin = parts[2].trim();
                const color = parts[3].trim();

                const sinners = ["Yi Sang", "Faust", "Don Quixote", "Ryōshū", "Meursault", "Hong Lu", "Heathcliff", "Ishmael", "Rodion", "Sinclair", "Outis", "Gregor"];
                let sinner = "Unknown";
                let name = nameAndSinner;

                for (const s of sinners) {
                    if (nameAndSinner.includes(s)) {
                        sinner = s;
                        name = nameAndSinner.replace(s, '').trim();
                        break;
                    }
                }
                
                egoList.push({
                    id: createSlug(`${name} ${sinner}`),
                    name: `${name} (${sinner})`, sinner, rarity, sin, color,
                    cssColor: bgColorMap[color] || 'rgba(128, 128, 128, 0.7)'
                });
            });
            return egoList;
        }

        // ======================
        // ROSTER CODE SYSTEM
        // ======================
        function generateRosterCode() {
            if (state.builderRoster.length !== ROSTER_SIZE) return null;
            try {
                const indices = state.builderRoster.map(slug => {
                    const index = state.masterIDList.findIndex(id => id.id === slug);
                    return index > -1 ? index : 255; // Use 255 as an error/not found marker
                });
                const uint8Array = new Uint8Array(indices);
                const binaryString = String.fromCharCode.apply(null, uint8Array);
                return btoa(binaryString);
            } catch (e) {
                console.error("Error generating roster code:", e);
                return null;
            }
        }

        function loadRosterFromCode(code) {
            try {
                const binaryString = atob(code);
                if (binaryString.length !== ROSTER_SIZE) {
                    showNotification("Invalid roster code: incorrect length.", true);
                    return null;
                }
                const uint8Array = new Uint8Array(binaryString.split('').map(c => c.charCodeAt(0)));
                const rosterSlugs = Array.from(uint8Array).map(index => {
                    return (index < state.masterIDList.length) ? state.masterIDList[index].id : null;
                }).filter(Boolean);

                if (rosterSlugs.length !== ROSTER_SIZE) {
                    showNotification("Invalid roster code: contains invalid ID data.", true);
                    return null;
                }
                return rosterSlugs;
            } catch (e) {
                console.error("Error decoding roster code:", e);
                showNotification("Invalid roster code format.", true);
                return null;
            }
        }

        // ======================
        // SOCKET COMMUNICATION
        // ======================
        function connectWebSocket() {
            const loc = window.location;
            const wsProtocol = loc.protocol === 'https:' ? 'wss:' : 'ws:';
            const remoteUrl = `${wsProtocol}//${loc.host}/`;
            state.socket = new WebSocket(remoteUrl);

            state.socket.onopen = () => {
                elements.connectionStatus.innerHTML = '<i class="fas fa-plug"></i> <span>Connected</span>';
                elements.connectionStatus.classList.add('connected');
            };
            state.socket.onmessage = (event) => handleServerMessage(JSON.parse(event.data));
            state.socket.onclose = () => {
                elements.connectionStatus.innerHTML = '<i class="fas fa-plug"></i> <span>Disconnected</span>';
                elements.connectionStatus.classList.remove('connected');
            };
            state.socket.onerror = (error) => console.error('WebSocket error:', error);
        }
        
        function sendMessage(message) {
            if (state.socket && state.socket.readyState === WebSocket.OPEN) {
                state.socket.send(JSON.stringify(message));
            }
        }
        
        function handleServerMessage(message) {
            console.log("Received from server:", message);
            switch (message.type) {
                case 'lobbyCreated': handleLobbyCreated(message); break;
                case 'lobbyJoined': handleLobbyJoined(message); break;
                case 'stateUpdate': handleStateUpdate(message); break;
                case 'notification': showNotification(message.text); break;
                case 'error': showNotification(`Error: ${message.message}`, true); break;
            }
        }

        // ======================
        // UI RENDERING & DOM MANIPULATION
        // ======================
        function createIdElement(idData, options = {}) {
            const { isSelected, clickHandler } = options;
            const idElement = document.createElement('div');
            idElement.className = `id-item rarity-${idData.rarity} ${isSelected ? 'selected' : ''}`;
            idElement.dataset.id = idData.id;
            idElement.innerHTML = `<div class="id-icon" style="background-image: url('/uploads/${idData.imageFile}')"></div><div class="id-name">${idData.name}</div>`;
            if (clickHandler) {
                idElement.addEventListener('click', () => clickHandler(idData.id));
            }
            return idElement;
        }

        function createEgoElement(egoData, clickHandler) {
            const egoElement = document.createElement('div');
            const allBans = [...state.draft.egoBans.p1, ...state.draft.egoBans.p2];
            const isBanned = allBans.includes(egoData.id);

            egoElement.className = `ego-item ${isBanned ? 'banned' : ''}`;
            if (state.draft.egoBans.p1.includes(egoData.id)) egoElement.classList.add('banned-p1');
            if (state.draft.egoBans.p2.includes(egoData.id)) egoElement.classList.add('banned-p2');

            egoElement.dataset.id = egoData.id;
            egoElement.style.backgroundColor = egoData.cssColor;

            egoElement.innerHTML = `
                <div class="ego-header"><span class="ego-rarity">${egoData.rarity}</span></div>
                <div class="ego-name">${egoData.name}</div>`;
            
            if (clickHandler && !isBanned) {
                egoElement.addEventListener('click', () => clickHandler(egoData.id));
            }
            return egoElement;
        }

        function renderIDList(container, idObjectList, selectionSet, clickHandler) {
            container.innerHTML = '';
            container.className = 'roster-selection'; // Reset class to default
            if (!Array.isArray(idObjectList) || idObjectList.length === 0) {
                if(!container.classList.contains('ban-list') && !container.classList.contains('pick-list')) {
                   container.innerHTML = '<div class="empty-roster" style="padding: 10px; text-align: center;">No items to display</div>';
                }
                return;
            }
            
            const fragment = document.createDocumentFragment();
            idObjectList.forEach(idData => {
                if (!idData) return;
                const isSelected = selectionSet ? selectionSet.includes(idData.id) : false;
                const element = createIdElement(idData, { isSelected, clickHandler: clickHandler ? () => clickHandler(idData.id) : null });
                fragment.appendChild(element);
            });
            container.appendChild(fragment);
        }

        function renderGroupedView(container, idObjectList, options = {}) {
            const { clickHandler, selectionSet } = options;

            container.innerHTML = '';
            container.className = 'sinner-grouped-roster';

            if (!Array.isArray(idObjectList) || idObjectList.length === 0) {
                container.innerHTML = '<div class="empty-roster" style="padding: 10px; text-align: center;">No items to display.</div>';
                return;
            }

            const groupedBySinner = {};
            const sinnerOrder = ["Yi Sang", "Faust", "Don Quixote", "Ryōshū", "Meursault", "Hong Lu", "Heathcliff", "Ishmael", "Rodion", "Sinclair", "Outis", "Gregor"];

            idObjectList.forEach(id => {
                if (!id) return;
                if (!groupedBySinner[id.sinner]) {
                    groupedBySinner[id.sinner] = [];
                }
                groupedBySinner[id.sinner].push(id);
            });

            const fragment = document.createDocumentFragment();
            let isFirstRenderedGroup = true;

            sinnerOrder.forEach(sinnerName => {
                if (groupedBySinner[sinnerName] && groupedBySinner[sinnerName].length > 0) {
                    const sinnerRow = document.createElement('div');
                    sinnerRow.className = 'sinner-row';

                    if (!isFirstRenderedGroup) {
                        const sinnerHeader = document.createElement('div');
                        sinnerHeader.className = 'sinner-header';
                        sinnerRow.appendChild(sinnerHeader);
                    }
                    isFirstRenderedGroup = false;

                    const idContainer = document.createElement('div');
                    idContainer.className = 'sinner-id-container';

                    const sortedIds = groupedBySinner[sinnerName].sort((a,b) => {
                        const indexA = state.masterIDList.findIndex(item => item.id === a.id);
                        const indexB = state.masterIDList.findIndex(item => item.id === b.id);
                        return indexA - indexB;
                    });

                    sortedIds.forEach(idData => {
                        const isSelected = selectionSet ? selectionSet.includes(idData.id) : false;
                        const idElement = createIdElement(idData, { isSelected, clickHandler });
                        idContainer.appendChild(idElement);
                    });
                    sinnerRow.appendChild(idContainer);
                    fragment.appendChild(sinnerRow);
                }
            });

            container.appendChild(fragment);
        }
        
        function switchView(view) {
            state.currentView = view;
            ['mainPage', 'lobbyView', 'completedView', 'rosterBuilderPage'].forEach(page => {
                elements[page].style.display = 'none';
            });
            if(elements[view]) elements[view].style.display = 'block';
        }

        function updateAllUIsFromState() {
            const { phase } = state.draft;

            // View switching
            if (phase === 'complete') {
                switchView('completedView');
                renderCompletedView();
                return;
            }
            if (state.lobbyCode) switchView('lobbyView');
            else if (state.currentView !== 'rosterBuilderPage') switchView('mainPage');


            elements.rosterPhase.classList.toggle('hidden', phase !== 'roster');
            elements.egoBanPhase.classList.toggle('hidden', phase !== 'egoBan');
            elements.idDraftPhase.classList.toggle('hidden', !['ban', 'pick', 'midBan', 'pick2'].includes(phase));

            // Participants list
            elements.participantsList.innerHTML = '';
            ['p1', 'p2', 'ref'].forEach(role => {
                const p = state.participants[role];
                const displayName = state.userRole === role ? `${p.name} (You)` : p.name;
                const el = document.createElement('div');
                el.className = `participant ${state.userRole === role ? 'current-user' : ''}`;
                const icon = role === 'ref' ? 'fa-star' : 'fa-user';
                let statusIcon = '<i class="fas fa-times-circle" style="color:var(--disconnected);"></i>';
                if (p.status === 'connected') {
                    statusIcon = (role !== 'ref' && p.ready) ? ` <i class="fas fa-check-circle" style="color:var(--ready);"></i>` : ` <i class="fas fa-dot-circle" style="color:var(--connected);"></i>`;
                }
                el.innerHTML = `<i class="fas ${icon}"></i> ${displayName} ${statusIcon}`;
                elements.participantsList.appendChild(el);
            });

            // Player names and status for roster phase
            ['p1', 'p2'].forEach(player => {
                elements[`${player}NameDisplay`].textContent = state.participants[player].name;
                elements[`${player}Counter`].textContent = state.roster[player].length;
                const isReady = state.participants[player].ready;
                elements[`${player}Ready`].innerHTML = isReady ? '<i class="fas fa-times"></i> Unready' : `<i class="fas fa-check"></i> Ready`;
                elements[`${player}Ready`].classList.toggle('btn-ready', isReady);
                elements[`${player}Status`].textContent = isReady ? 'Ready' : 'Selecting';
                elements[`${player}Status`].className = `player-status ${isReady ? 'status-ready' : 'status-waiting'}`;
                elements[`${player}Panel`].classList.toggle('locked', isReady);
            });
            
            filterAndRenderRosterSelection();
            
            if (phase === 'egoBan') renderEgoBanPhase();
            if (['ban', 'pick', 'midBan', 'pick2'].includes(phase)) updateDraftUI();
            
            updateDraftInstructions();
            checkPhaseReadiness();
        }
        
        function filterAndRenderRosterSelection() {
            const filteredList = filterIDs(state.masterIDList, state.filters);
            renderIDList(elements.p1Roster, filteredList, state.roster.p1, (id) => toggleIDSelection('p1', id));
            renderIDList(elements.p2Roster, filteredList, state.roster.p2, (id) => toggleIDSelection('p2', id));
        }

        function filterIDs(sourceList, filterObject) {
            const searchTerm = filterObject.rosterSearch.toLowerCase();
            return sourceList.filter(fullData => {
                if (!fullData) return false;
                if (filterObject.sinner && fullData.sinner !== filterObject.sinner) return false;
                if (filterObject.sinAffinity && !fullData.sinAffinities.includes(filterObject.sinAffinity)) return false;
                if (filterObject.keyword && !fullData.keywords.includes(filterObject.keyword)) return false;
                if (searchTerm && !fullData.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
        }
        
        function renderEgoBanPhase() {
            const { currentPlayer } = state.draft;
            const opponent = currentPlayer === 'p1' ? 'p2' : 'p1';

            elements.egoBanPhase.className = `phase-section ${currentPlayer}-banning`;

            // Render EGOs
            const container = elements.egoBanContainer;
            container.innerHTML = '';
            const fragment = document.createDocumentFragment();
            const clickHandler = (state.userRole === currentPlayer || state.userRole === 'ref') ? selectEgoToBan : null;
            
            const searchTerm = state.egoSearch.toLowerCase();
            const filteredEgos = state.masterEGOList.filter(ego => 
                !searchTerm || ego.name.toLowerCase().includes(searchTerm)
            );

            filteredEgos.forEach(ego => {
                fragment.appendChild(createEgoElement(ego, clickHandler));
            });
            container.appendChild(fragment);

            // Render Opponent Roster using the new grouped view
            elements.opponentRosterTitle.textContent = `${state.participants[opponent].name}'s Roster`;
            const opponentRosterObjects = state.roster[opponent].map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
            renderGroupedView(elements.opponentRosterList, opponentRosterObjects);


            const canConfirm = (state.userRole === 'ref' || state.userRole === currentPlayer) && state.draft.egoBans[currentPlayer].length === EGO_BAN_COUNT;
            elements.confirmEgoBans.disabled = !canConfirm;
        }

        function renderBannedEgosDisplay() {
            const allBans = [...state.draft.egoBans.p1, ...state.draft.egoBans.p2];
            const bannedEgoObjects = allBans.map(id => state.masterEGOList.find(ego => ego.id === id)).filter(Boolean);
            
            const renderList = (container) => {
                container.innerHTML = '';
                bannedEgoObjects.forEach(ego => {
                    const item = document.createElement('div');
                    item.className = 'banned-ego-item';
                    item.style.backgroundColor = ego.cssColor;
                    item.innerHTML = `<span class="rarity">[${ego.rarity}]</span> <span class="name">${ego.name}</span>`;
                    container.appendChild(item);
                });
            };

            renderList(elements.draftBannedEgosList);
            renderList(elements.finalBannedEgosList);
        }

        function updateDraftUI() {
            const renderIdSublist = (container, idList) => {
                const idObjects = idList.map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
                renderIDList(container, idObjects, null, null);
            };
            
            renderIdSublist(elements.p1IdBans, state.draft.idBans.p1);
            renderIdSublist(elements.p2IdBans, state.draft.idBans.p2);
            renderIdSublist(elements.p1Picks, state.draft.picks.p1);
            renderIdSublist(elements.p2Picks, state.draft.picks.p2);
            
            const { currentPlayer } = state.draft;
            elements.p1DraftStatus.textContent = currentPlayer === "p1" ? "Drafting" : "Waiting";
            elements.p2DraftStatus.textContent = currentPlayer === "p2" ? "Drafting" : "Waiting";
            elements.p1DraftStatus.className = `player-status ${currentPlayer === "p1" ? "status-drafting" : "status-waiting"}`;
            elements.p2DraftStatus.className = `player-status ${currentPlayer === "p2" ? "status-drafting" : "status-waiting"}`;
            elements.p1DraftPanel.classList.toggle('draft-active', currentPlayer === 'p1');
            elements.p2DraftPanel.classList.toggle('draft-active', currentPlayer === 'p2');

            renderBannedEgosDisplay();
        }

        function updateDraftInstructions() {
            let phaseText = "", actionDesc = "";
            const { phase, step, currentPlayer, action, actionCount, egoBans } = state.draft;
            
            // Reset draft selection containers to their default state
            elements.p1DraftSelection.className = 'roster-selection';
            elements.p1DraftSelection.innerHTML = '<div class="empty-roster"></div>';
            elements.p2DraftSelection.className = 'roster-selection';
            elements.p2DraftSelection.innerHTML = '<div class="empty-roster"></div>';

            switch(phase) {
                case "roster": 
                    phaseText = "Roster Selection";
                    actionDesc = "Players select 42 IDs. Referee starts the draft when both are ready.";
                    break;
                case "egoBan":
                    const bansLeft = EGO_BAN_COUNT - (egoBans[currentPlayer] ? egoBans[currentPlayer].length : 0);
                    phaseText = `EGO Ban Phase - ${state.participants[currentPlayer].name}'s turn`;
                    actionDesc = `Select ${bansLeft} more EGO(s) to ban from the global pool.`;
                    break;
                case "ban": 
                    phaseText = `Ban Phase 1 - Step ${step + 1}/8`; 
                    actionDesc = `${state.participants[currentPlayer].name} to ban 1 ID from opponent's roster`; 
                    break;
                case "pick": 
                    phaseText = `Pick Phase 1 - Step ${step + 1}/7`; 
                    actionDesc = `${state.participants[currentPlayer].name} to pick ${actionCount} ID(s)`; 
                    break;
                case "midBan": 
                    phaseText = `Mid-Ban Phase - Step ${step + 1}/6`; 
                    actionDesc = `${state.participants[currentPlayer].name} to ban 1 ID from opponent's remaining roster`; 
                    break;
                case "pick2": 
                    phaseText = `Pick Phase 2 - Step ${step + 1}/7`; 
                    actionDesc = `${state.participants[currentPlayer].name} to pick ${actionCount} ID(s)`; 
                    break;
                case "complete":
                    phaseText = "Draft Completed!";
                    actionDesc = "All picks and bans are finalized.";
                    break;
                default:
                    phaseText = "Waiting for draft to start...";
            }

            if (['ban', 'pick', 'midBan', 'pick2'].includes(phase)) {
                const opponent = currentPlayer === 'p1' ? 'p2' : 'p1';
                const isBanAction = action.includes('ban');

                const availableIdList = isBanAction ? state.draft.available[opponent] : state.draft.available[currentPlayer];
                let availableObjects = availableIdList.map(id => state.masterIDList.find(item => item && item.id === id)).filter(Boolean);
                
                availableObjects = filterIDs(availableObjects, state.draftFilters);
                
                const selectionContainer = currentPlayer === 'p1' ? elements.p1DraftSelection : elements.p2DraftSelection;
                const clickHandler = (state.userRole === currentPlayer || state.userRole === 'ref') ? (id) => selectDraftID(currentPlayer, id) : null;
                
                let selectionSet;
                if (isBanAction) {
                    selectionSet = state.roster[currentPlayer];
                } else {
                    selectionSet = availableIdList;
                }
                
                renderGroupedView(selectionContainer, availableObjects, { selectionSet, clickHandler });
            }
            
            elements.currentPhase.textContent = phaseText;
            elements.draftActionDescription.textContent = actionDesc;
            elements.nextPhase.disabled = state.userRole !== 'ref' || phase === 'complete';
            elements.completeDraft.disabled = state.userRole !== 'ref' || phase === 'complete';
        }

        function renderCompletedView() {
            const renderFinalList = (container, idList) => {
                const idObjects = idList.map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
                renderIDList(container, idObjects, null, null);
            };

            elements.finalP1Name.textContent = `${state.participants.p1.name}'s Roster`;
            elements.finalP2Name.textContent = `${state.participants.p2.name}'s Roster`;

            const balanceAndRenderPicks = (player) => {
                const pickObjects = state.draft.picks[player].map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
                
                const groupedBySinner = {};
                pickObjects.forEach(id => {
                    if (!groupedBySinner[id.sinner]) {
                        groupedBySinner[id.sinner] = [];
                    }
                    groupedBySinner[id.sinner].push(id);
                });

                const col1Ids = [];
                const col2Ids = [];
                let col1Count = 0;
                let col2Count = 0;
                const sinnerOrder = ["Yi Sang", "Faust", "Don Quixote", "Ryōshū", "Meursault", "Hong Lu", "Heathcliff", "Ishmael", "Rodion", "Sinclair", "Outis", "Gregor"];

                sinnerOrder.forEach(sinnerName => {
                    if (groupedBySinner[sinnerName]) {
                        const sinnerGroup = groupedBySinner[sinnerName];
                        if (col1Count <= col2Count) {
                            col1Ids.push(...sinnerGroup);
                            col1Count += sinnerGroup.length;
                        } else {
                            col2Ids.push(...sinnerGroup);
                            col2Count += sinnerGroup.length;
                        }
                    }
                });

                renderGroupedView(elements[`final${player}PicksCol1`], col1Ids);
                renderGroupedView(elements[`final${player}PicksCol2`], col2Ids);
            };

            balanceAndRenderPicks('p1');
            balanceAndRenderPicks('p2');

            renderFinalList(elements.finalP1Bans, state.draft.idBans.p2); 
            renderFinalList(elements.finalP2Bans, state.draft.idBans.p1);
            renderBannedEgosDisplay();
        }

        function checkPhaseReadiness() {
            if (state.draft.phase === 'roster') {
                const p1Ready = state.participants.p1.ready && state.roster.p1.length === ROSTER_SIZE;
                const p2Ready = state.participants.p2.ready && state.roster.p2.length === ROSTER_SIZE;
                if (state.userRole === 'ref') {
                    elements.startEgoBan.disabled = !(p1Ready && p2Ready);
                }
            }
        }
        
        function renderRosterBuilder() {
            // --- Render Sinner Navigation (Left Panel) ---
            const sinnerNav = elements.builderSinnerNav;
            sinnerNav.innerHTML = '';
            const sinnerOrder = ["Yi Sang", "Faust", "Don Quixote", "Ryōshū", "Meursault", "Hong Lu", "Heathcliff", "Ishmael", "Rodion", "Sinclair", "Outis", "Gregor"];
            
            sinnerOrder.forEach(sinnerName => {
                const btn = document.createElement('button');
                btn.className = 'btn sinner-nav-btn';
                btn.textContent = sinnerName;
                if (sinnerName === state.builderSelectedSinner) {
                    btn.classList.add('selected');
                }
                btn.addEventListener('click', () => {
                    state.builderSelectedSinner = sinnerName;
                    renderRosterBuilder(); // Re-render the whole builder view
                });
                sinnerNav.appendChild(btn);
            });

            // --- Render ID Pool (Center Panel) ---
            const sinnerIDs = state.idsBySinner[state.builderSelectedSinner];
            const filteredSinnerIDs = filterIDs(sinnerIDs, state.filters);
            renderIDList(elements.builderIdPool, filteredSinnerIDs, state.builderRoster, toggleBuilderIdSelection);


            // --- Render Selected Roster (Right Panel) ---
            const sortedSelectedRoster = [...state.builderRoster].sort((a, b) => {
                const indexA = state.masterIDList.findIndex(item => item.id === a);
                const indexB = state.masterIDList.findIndex(item => item.id === b);
                return indexA - indexB;
            });
            const selectedObjects = sortedSelectedRoster.map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
            
            renderGroupedView(elements.builderSelectedRoster, selectedObjects, { 
                selectionSet: state.builderRoster, 
                clickHandler: toggleBuilderIdSelection 
            });

            elements.builderCounter.textContent = state.builderRoster.length;
            
            if(state.builderRoster.length === ROSTER_SIZE) {
                const code = generateRosterCode();
                elements.builderRosterCodeDisplay.textContent = code || "Error generating code.";
                elements.builderCopyCode.disabled = !code;
            } else {
                elements.builderRosterCodeDisplay.textContent = `Select ${ROSTER_SIZE - state.builderRoster.length} more IDs to generate a code.`;
                elements.builderCopyCode.disabled = true;
            }
        }


        // ======================
        // CLIENT ACTIONS & EVENT HANDLERS
        // ======================
        function toggleIDSelection(player, id) {
            if (state.participants[player].ready) {
                showNotification("Cannot change roster while ready.");
                return;
            }
            sendMessage({ type: 'rosterSelect', lobbyCode: state.lobbyCode, player, id });
        }

        function setPlayerRoster(player, roster) {
            if (state.participants[player].ready) {
                showNotification("Cannot change roster while ready.");
                return;
            }
            sendMessage({ type: 'rosterSet', lobbyCode: state.lobbyCode, player, roster });
        }

        function selectEgoToBan(egoId) {
             sendMessage({ type: 'egoBan', lobbyCode: state.lobbyCode, egoId });
        }
        
        function selectDraftID(player, id) {
            sendMessage({ type: 'draftSelect', lobbyCode: state.lobbyCode, payload: { player, id } });
        }

        function toggleBuilderIdSelection(id) {
            const index = state.builderRoster.indexOf(id);
            if (index > -1) {
                state.builderRoster.splice(index, 1);
            } else {
                if (state.builderRoster.length < ROSTER_SIZE) {
                    state.builderRoster.push(id);
                } else {
                    showNotification(`You can only select ${ROSTER_SIZE} IDs.`);
                }
            }
            // Re-render the builder to update selections and side panel
            renderRosterBuilder();
        }

        // ======================
        // STATE HANDLERS
        // ======================
        function handleLobbyCreated(message) {
            state.lobbyCode = message.code;
            state.userRole = 'ref';
            handleStateUpdate(message);
        }
        
        function handleLobbyJoined(message) {
            state.lobbyCode = message.lobbyCode;
            state.userRole = message.role;
            handleStateUpdate(message);
            showNotification(`Joined lobby as ${state.participants[state.userRole].name}`);
        }
        
        function handleStateUpdate(message) {
            state.participants = message.state.participants;
            state.roster = message.state.roster;
            state.draft = message.state.draft;
            elements.lobbyCodeDisplay.textContent = state.lobbyCode;
            updateAllUIsFromState();
        }

        // ======================
        // INITIALIZATION
        // ======================
        function setupFilterBar(barId, filterStateObject) {
            const bar = document.getElementById(barId);
            if (!bar) return;

            const update = () => {
                if (state.currentView === 'lobbyView') {
                    if (state.draft.phase === 'roster') filterAndRenderRosterSelection();
                    else updateDraftInstructions();
                } else if (state.currentView === 'rosterBuilderPage') {
                    renderRosterBuilder();
                }
            };

            bar.addEventListener('input', (e) => {
                if (e.target.classList.contains('roster-search-input')) {
                    filterStateObject.rosterSearch = e.target.value;
                    update();
                }
            });
            bar.addEventListener('change', (e) => {
                const filterType = e.target.dataset.filter;
                if (filterType) {
                    filterStateObject[filterType] = e.target.value;
                    update();
                }
            });
            bar.addEventListener('click', (e) => {
                if (e.target.closest('.reset-filters-btn')) {
                    Object.keys(filterStateObject).forEach(key => filterStateObject[key] = "");
                    bar.querySelectorAll('input, select').forEach(el => el.value = "");
                    update();
                }
            });
        }

        function setupEventListeners() {
            // Main Page
            elements.createLobbyBtn.addEventListener('click', () => sendMessage({ type: 'createLobby', name: elements.playerNameInput.value.trim() }));
            elements.joinLobbyBtn.addEventListener('click', () => {
                elements.lobbyAccessForm.style.display = 'block';
                elements.joinLobbyBtn.style.display = 'none';
            });
            elements.goToBuilder.addEventListener('click', () => {
                state.builderSelectedSinner = "Yi Sang"; // Reset to default
                switchView('rosterBuilderPage');
                renderRosterBuilder();
            });
            elements.roleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    elements.roleOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            elements.enterLobbyBtn.addEventListener('click', () => {
                const lobbyCode = elements.lobbyCodeInput.value.trim().toUpperCase();
                const selectedRole = document.querySelector('.role-option.selected')?.dataset.role;
                if (!lobbyCode || !selectedRole) return showNotification('Enter code and select a role.', true);
                sendMessage({ type: 'joinLobby', lobbyCode, role: selectedRole, name: elements.playerNameInput.value.trim() });
            });
            
            // Back buttons
            elements.backToMainLobby.addEventListener('click', () => window.location.reload());
            elements.backToMainBuilder.addEventListener('click', () => {
                state.lobbyCode = ''; // Ensure we don't accidentally return to a lobby
                switchView('mainPage');
            });
            elements.restartDraft.addEventListener('click', () => window.location.reload());
            
            // Lobby Roster Controls
            ['p1', 'p2'].forEach(player => {
                elements[`${player}Random`].addEventListener('click', () => (state.userRole === player || state.userRole === 'ref') && sendMessage({ type: 'rosterRandomize', lobbyCode: state.lobbyCode, player }));
                elements[`${player}Clear`].addEventListener('click', () => (state.userRole === player || state.userRole === 'ref') && sendMessage({ type: 'rosterClear', lobbyCode: state.lobbyCode, player }));
                elements[`${player}Ready`].addEventListener('click', () => {
                    if (state.userRole === player || state.userRole === 'ref') {
                         if (state.roster[player].length !== ROSTER_SIZE && !state.participants[player].ready) return showNotification(`Must select ${ROSTER_SIZE} IDs.`, true);
                        sendMessage({ type: 'updateReady', lobbyCode: state.lobbyCode, player });
                    }
                });
                elements[`${player}RosterLoad`].addEventListener('click', () => {
                    if (state.userRole === player || state.userRole === 'ref') {
                        const code = elements[`${player}RosterCodeInput`].value.trim();
                        const roster = loadRosterFromCode(code);
                        if (roster) {
                            setPlayerRoster(player, roster);
                            showNotification("Roster loaded successfully!");
                        }
                    }
                });
            });
            
            // Roster Builder Controls
            elements.builderRandom.addEventListener('click', () => {
                const shuffled = [...state.masterIDList].sort(() => 0.5 - Math.random());
                state.builderRoster = shuffled.slice(0, ROSTER_SIZE).map(id => id.id);
                renderRosterBuilder();
            });
            elements.builderClear.addEventListener('click', () => {
                state.builderRoster = [];
                renderRosterBuilder();
            });
            elements.builderCopyCode.addEventListener('click', () => {
                const code = elements.builderRosterCodeDisplay.textContent;
                navigator.clipboard.writeText(code).then(() => {
                    showNotification("Roster code copied to clipboard!");
                }, () => {
                    showNotification("Failed to copy code.", true);
                });
            });
            elements.builderLoadCode.addEventListener('click', () => {
                const code = elements.builderLoadCodeInput.value.trim();
                const roster = loadRosterFromCode(code);
                if (roster) {
                    state.builderRoster = roster;
                    renderRosterBuilder();
                    showNotification("Roster loaded successfully!");
                }
            });

            // EGO Search
            elements.egoSearchInput.addEventListener('input', (e) => {
                state.egoSearch = e.target.value;
                renderEgoBanPhase();
            });

            // Draft controls
            elements.startEgoBan.addEventListener('click', () => sendMessage({ type: 'draftControl', lobbyCode: state.lobbyCode, action: 'startEgoBan' }));
            elements.confirmEgoBans.addEventListener('click', () => sendMessage({ type: 'draftControl', lobbyCode: state.lobbyCode, action: 'confirmEgoBans' }));
            elements.nextPhase.addEventListener('click', () => sendMessage({ type: 'draftControl', lobbyCode: state.lobbyCode, action: 'nextPhase' }));
            elements.completeDraft.addEventListener('click', () => sendMessage({ type: 'draftControl', lobbyCode: state.lobbyCode, action: 'complete' }));
        }

        function createFilterBarHTML(options = {}) {
            const { showSinnerFilter = true } = options;
            const sinnerFilterHTML = `
                <div class="filter-group">
                    <label class="filter-label">Filter by Sinner:</label>
                    <select class="sinner-filter" data-filter="sinner">
                        <option value="">All Sinners</option>
                        <option value="Yi Sang">Yi Sang</option><option value="Faust">Faust</option><option value="Don Quixote">Don Quixote</option>
                        <option value="Ryōshū">Ryōshū</option><option value="Meursault">Meursault</option><option value="Hong Lu">Hong Lu</option>
                        <option value="Heathcliff">Heathcliff</option><option value="Ishmael">Ishmael</option><option value="Rodion">Rodion</option>
                        <option value="Sinclair">Sinclair</option><option value="Outis">Outis</option><option value="Gregor">Gregor</option>
                    </select>
                </div>
            `;

            return `
                <div class="filter-group">
                    <label class="filter-label">Search by Name:</label>
                    <input type="text" class="roster-search-input" placeholder="e.g. LCB Sinner...">
                </div>
                ${showSinnerFilter ? sinnerFilterHTML : ''}
                <div class="filter-group">
                    <label class="filter-label">Filter by Sin Affinity:</label>
                    <select class="sinAffinity-filter" data-filter="sinAffinity">
                        <option value="">All Affinities</option>
                        <option value="Gloom">Gloom</option><option value="Lust">Lust</option><option value="Sloth">Sloth</option>
                        <option value="Wrath">Wrath</option><option value="Gluttony">Gluttony</option><option value="Envy">Envy</option><option value="Pride">Pride</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Filter by Keyword:</label>
                    <select class="keyword-filter" data-filter="keyword">
                        <option value="">All Keywords</option>
                        <option value="Sinking">Sinking</option><option value="Rupture">Rupture</option><option value="Discard">Discard</option>
                        <option value="Tremor">Tremor</option><option value="Bleed">Bleed</option><option value="Poise">Poise</option>
                        <option value="Aggro">Aggro</option><option value="Charge">Charge</option><option value="Burn">Burn</option><option value="Ammo">Ammo</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button class="btn reset-filters-btn"><i class="fas fa-sync"></i> Reset</button>
                </div>
            `;
        }

        function cacheDOMElements() {
             elements = {
                // Pages
                mainPage: document.getElementById('main-page'),
                lobbyView: document.getElementById('lobby-view'),
                rosterBuilderPage: document.getElementById('roster-builder-page'),
                completedView: document.getElementById('completed-view'),

                // Main Page
                lobbyAccessForm: document.getElementById('lobby-access-form'),
                createLobbyBtn: document.getElementById('create-lobby'),
                joinLobbyBtn: document.getElementById('join-lobby'),
                goToBuilder: document.getElementById('go-to-builder'),
                enterLobbyBtn: document.getElementById('enter-lobby'),
                lobbyCodeInput: document.getElementById('lobby-code'),
                roleOptions: document.querySelectorAll('.role-option'),
                playerNameInput: document.getElementById('player-name'),

                // Shared
                backToMainLobby: document.getElementById('back-to-main-lobby'),
                backToMainBuilder: document.getElementById('back-to-main-builder'),
                connectionStatus: document.getElementById('connection-status'),
                notification: document.getElementById('notification'),
                
                // Lobby
                lobbyCodeDisplay: document.getElementById('lobby-code-display'),
                participantsList: document.getElementById('participants-list'),
                phaseTimer: document.getElementById('phase-timer'),
                draftStatusPanel: document.getElementById('draft-status-panel'),
                currentPhase: document.getElementById('current-phase'),
                draftActionDescription: document.getElementById('draft-action-description'),
                
                // Roster Phase (Lobby)
                rosterPhase: document.getElementById('roster-phase'),
                p1Panel: document.getElementById('p1-panel'), p2Panel: document.getElementById('p2-panel'),
                p1Roster: document.getElementById('p1-roster'), p2Roster: document.getElementById('p2-roster'),
                p1Counter: document.getElementById('p1-counter'), p2Counter: document.getElementById('p2-counter'),
                p1Random: document.getElementById('p1-random'), p2Random: document.getElementById('p2-random'),
                p1Clear: document.getElementById('p1-clear'), p2Clear: document.getElementById('p2-clear'),
                p1Ready: document.getElementById('p1-ready'), p2Ready: document.getElementById('p2-ready'),
                p1Status: document.getElementById('p1-status'), p2Status: document.getElementById('p2-status'),
                p1NameDisplay: document.getElementById('p1-name-display'), p2NameDisplay: document.getElementById('p2-name-display'),
                p1RosterCodeInput: document.getElementById('p1-roster-code-input'), p2RosterCodeInput: document.getElementById('p2-roster-code-input'),
                p1RosterLoad: document.getElementById('p1-roster-load'), p2RosterLoad: document.getElementById('p2-roster-load'),
                startEgoBan: document.getElementById('start-ego-ban'),

                // Roster Builder
                builderSinnerNav: document.getElementById('builder-sinner-nav'),
                builderIdPool: document.getElementById('builder-id-pool'),
                builderSelectedRoster: document.getElementById('builder-selected-roster'),
                builderCounter: document.getElementById('builder-counter'),
                builderRandom: document.getElementById('builder-random'),
                builderClear: document.getElementById('builder-clear'),
                builderRosterCodeDisplay: document.getElementById('builder-roster-code-display'),
                builderCopyCode: document.getElementById('builder-copy-code'),
                builderLoadCodeInput: document.getElementById('builder-load-code-input'),
                builderLoadCode: document.getElementById('builder-load-code'),

                // EGO Ban Phase
                egoBanPhase: document.getElementById('ego-ban-phase'),
                egoSearchInput: document.getElementById('ego-search-input'),
                egoBanContainer: document.getElementById('ego-ban-container'),
                confirmEgoBans: document.getElementById('confirm-ego-bans'),
                opponentRosterDisplay: document.getElementById('opponent-roster-display'),
                opponentRosterTitle: document.getElementById('opponent-roster-title'),
                opponentRosterList: document.getElementById('opponent-roster-list'),

                // ID Draft Phase
                idDraftPhase: document.getElementById('id-draft-phase'),
                draftBannedEgosList: document.getElementById('draft-banned-egos-list'),
                nextPhase: document.getElementById('next-phase'),
                completeDraft: document.getElementById('complete-draft'),
                p1DraftPanel: document.getElementById('p1-draft-panel'), p2DraftPanel: document.getElementById('p2-draft-panel'),
                p1DraftName: document.getElementById('p1-draft-name'), p2DraftName: document.getElementById('p2-draft-name'),
                p1DraftStatus: document.getElementById('p1-draft-status'), p2DraftStatus: document.getElementById('p2-draft-status'),
                p1DraftSelection: document.getElementById('p1-draft-selection'), p2DraftSelection: document.getElementById('p2-draft-selection'),
                p1IdBans: document.getElementById('p1-id-bans'), p2IdBans: document.getElementById('p2-id-bans'),
                p1Picks: document.getElementById('p1-picks'), p2Picks: document.getElementById('p2-picks'),

                // Completed View
                finalBannedEgosList: document.getElementById('final-banned-egos-list'),
                restartDraft: document.getElementById('restart-draft'), 
                finalP1Name: document.getElementById('final-p1-name'), finalP2Name: document.getElementById('final-p2-name'),
                finalP1PicksCol1: document.getElementById('final-p1-picks-col1'),
                finalP1PicksCol2: document.getElementById('final-p1-picks-col2'),
                finalP2PicksCol1: document.getElementById('final-p2-picks-col1'),
                finalP2PicksCol2: document.getElementById('final-p2-picks-col2'),
                finalP1Bans: document.getElementById('final-p1-bans'),   
                finalP2Bans: document.getElementById('final-p2-bans'),
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const idCsvData = `Name,Keywords,SinAffinities,Rarity
"LCB Sinner Yi Sang","Sinking","Gloom,Envy,Sloth","0"
"Seven Association South Section 6 Yi Sang","Rupture","Gloom,Gluttony,Sloth","00"
"Molar Office Fixer Yi Sang","Discard,Tremor","Lust,Sloth,Wrath","00"
"The Pequod First Mate Yi Sang","Bleed,Poise","Pride,Envy,Gluttony","00"
"Dieci Association South Section 4 Yi Sang","Aggro,Discard,Sinking","Gluttony,Lust,Sloth","00"
"LCE E.G.O::Lantern Yi Sang","Aggro,Rupture","Sloth,Envy,Gluttony","00"
"Blade Lineage Salsu Yi Sang","Poise","Pride,Envy,Sloth","000"
"Effloresced E.G.O::Spicebush Yi Sang","Sinking,Tremor","Gluttony,Sloth,Pride","000"
"W Corp. L3 Cleanup Agent Yi Sang","Charge,Rupture","Sloth,Gluttony,Gloom","000"
"The Ring Pointillist Student Yi Sang","Bleed,Random","Gloom,Lust,Sloth","000"
"Lobotomy E.G.O::Solemn Lament Yi Sang","Ammo,Sinking","Pride,Gloom,Sloth","000"
"Liu Association South Section 3 Yi Sang","Burn","Sloth,Wrath,Envy","000"
"N Corp. E.G.O::Fell Bullet Yi Sang","Bleed,Poise","Wrath,Lust,Pride","000"
"LCB Sinner Faust","","Pride,Sloth,Gluttony","0"
"W Corp. L2 Cleanup Agent Faust","Charge","Envy,Gloom,Wrath","00"
"Lobotomy Corp. Remnant Faust","Poise,Rupture","Sloth,Gloom,Envy","000"
"Zwei Association South Section 4 Faust","Aggro","Envy,Gloom,Lust","00"
"Wuthering Heights Butler Faust","Sinking","Gloom,Lust,Wrath","00"
"The One Who Grips Faust","Bleed","Envy,Lust,Pride","000"
"Seven Association South Section 4 Faust","Rupture","Envy,Gloom,Gluttony","000"
"Lobotomy E.G.O::Regret Faust","Tremor","Sloth,Pride,Wrath","000"
"Blade Lineage Salsu Faust","Bleed,Poise","Sloth,Pride,Gloom","000"
"MultiCrack Office Rep Faust","Charge","Lust,Envy,Gluttony","000"
"LCE E.G.O::Ardor Blossom Star Faust","Burn","Sloth,Pride,Wrath","000"
"Heishou Pack - Mao Branch Adept Faust","Rupture","Sloth,Pride,Gluttony","000"
"LCB Sinner Don Quixote","Bleed","Lust,Envy,Gluttony","0"
"Shi Association South Section 5 Director Don Quixote","Poise","Wrath,Envy,Lust","00"
"N Corp. Mittelhammer Don Quixote","Bleed,Tremor","Lust,Gluttony,Wrath","00"
"Lobotomy E.G.O::Lantern Don Quixote","Aggro,Rupture","Gluttony,Lust,Gloom","00"
"Blade Lineage Salsu Don Quixote","Poise","Pride,Envy,Sloth","00"
"W Corp. L3 Cleanup Agent Don Quixote","Charge,Rupture","Sloth,Gloom,Envy","000"
"Cinq Association South Section 5 Director Don Quixote","","Lust,Gloom,Pride","000"
"The Middle Little Sister Don Quixote","Bleed","Wrath,Envy,Pride","000"
"T Corp. Class 3 Collection Staff Don Quixote","Aggro,Tremor","Gluttony,Pride,Sloth","000"
"The Manager of La Manchaland Don Quixote","Bleed","Sloth,Wrath,Lust","000"
"Cinq Association East Section 3 Don Quixote","Burn,Poise","Gluttony,Wrath,Pride","000"
"Lobotomy E.G.O::In the Name of Love and Hate Don Quixote","Rupture,Sinking","Wrath,Envy,Envy","000"
"LCB Sinner Ryōshū","Poise","Gluttony,Lust,Pride","0"
"Seven Association South Section 6 Ryōshū","Rupture","Sloth,Pride,Gluttony","00"
"LCCB Assistant Manager Ryōshū","Ammo,Poise,Rupture,Tremor","Lust,Gluttony,Pride","00"
"Liu Association South Section 4 Ryōshū","Burn","Gluttony,Wrath,Lust","00"
"District 20 Yurodivy Ryōshū","Tremor","Lust,Sloth,Gluttony","00"
"Kurokumo Clan Wakashu Ryōshū","Bleed","Gluttony,Pride,Lust","000"
"R.B. Chef de Cuisine Ryōshū","Bleed","Wrath,Envy,Lust","000"
"W Corp. L3 Cleanup Agent Ryōshū","Charge","Lust,Pride,Envy","000"
"Edgar Family Chief Butler Ryōshū","Poise","Lust,Pride,Wrath","000"
"Lobotomy E.G.O::Red Eyes & Penitence Ryōshū","Bleed","Envy,Gloom,Lust","000"
"Heishou Pack - Mao Branch Ryōshū","Rupture","Lust,Gluttony,Pride","00"
"LCB Sinner Meursault","Tremor","Sloth,Pride,Gloom","0"
"Liu Association South Section 6 Meursault","Burn","Lust,Sloth,Wrath","00"
"Rosespanner Workshop Fixer Meursault","Charge,Tremor","Gloom,Pride,Sloth","00"
"The Middle Little Brother Meursault","Bleed","Sloth,Envy,Wrath","00"
"Dead Rabbits Boss Meursault","Rupture","Lust,Wrath,Gluttony","00"
"W Corp. L2 Cleanup Agent Meursault","Charge,Rupture","Envy,Gluttony,Pride","000"
"N Corp. Großhammer Meursault","Aggro,Bleed","Sloth,Wrath,Pride","000"
"R Corp. 4th Pack Rhino Meursault","Bleed,Charge","Envy,Gloom,Lust","000"
"Blade Lineage Mentor Meursault","Poise","Pride,Pride,Wrath","000"
"Dieci Association South Section 4 Director Meursault","Discard,Sinking","Gluttony,Sloth,Gloom","000"
"Cinq Association West Section 3 Meursault","Poise,Rupture","Pride,Gluttony,Gloom","000"
"The Thumb East Capo IIII Meursault","Ammo,Burn,Tremor","Sloth,Lust,Wrath","000"
"LCB Sinner Hong Lu","Rupture,Sinking","Pride,Sloth,Lust","0"
"Kurokumo Clan Wakashu Hong Lu","Bleed","Lust,Pride,Sloth","00"
"Liu Association South Section 5 Hong Lu","Burn","Gloom,Lust,Wrath","00"
"W Corp. L2 Cleanup Agent Hong Lu","Charge,Rupture","Pride,Wrath,Gluttony","00"
"Hook Office Fixer Hong Lu","Bleed","Wrath,Lust,Pride","00"
"Fanghunt Office Fixer Hong Lu","Rupture","Gluttony,Pride,Wrath","00"
"Tingtang Gang Gangleader Hong Lu","Bleed","Envy,Lust,Gluttony","000"
"K Corp. Class 3 Excision Staff Hong Lu","Aggro,Rupture","Pride,Gluttony,Sloth","000"
"Dieci Association South Section 4 Hong Lu","Discard,Sinking","Wrath,Gloom,Sloth","000"
"District 20 Yurodivy Hong Lu","Tremor","Gloom,Sloth,Gluttony","000"
"Full-Stop Office Rep Hong Lu","Ammo,Poise","Sloth,Gloom,Pride","000"
"R Corp. 4th Pack Reindeer Hong Lu","Charge,Sinking","Gluttony,Envy,Wrath","000"
"LCB Sinner Heathcliff","Tremor","Envy,Wrath,Lust","0"
"Shi Association South Section 5 Heathcliff","Poise","Lust,Wrath,Envy","00"
"N Corp. Kleinhammer Heathcliff","Bleed","Envy,Gloom,Lust","00"
"Seven Association South Section 4 Heathcliff","Rupture","Wrath,Envy,Gluttony","00"
"MultiCrack Office Fixer Heathcliff","Charge","Wrath,Envy,Gloom","00"
"R Corp. 4th Pack Rabbit Heathcliff","Ammo,Bleed,Rupture","Wrath,Gluttony,Envy","000"
"Lobotomy E.G.O::Sunshower Heathcliff","Rupture,Sinking,Tremor","Envy,Gloom,Sloth","000"
"The Pequod Harpooneer Heathcliff","Aggro,Bleed,Poise","Pride,Envy,Envy","000"
"Öufi Association South Section 3 Heathcliff","Tremor","Envy,Gloom,Pride","000"
"Wild Hunt Heathcliff","Sinking","Wrath,Envy,Gloom","000"
"Full-Stop Office Fixer Heathcliff","Ammo,Poise","Gloom,Envy,Pride","000"
"Kurokumo Clan Wakashu Heathcliff","Bleed","Wrath,Pride,Lust","000"
"LCB Sinner Ishmael","Tremor","Wrath,Gluttony,Gloom","0"
"Shi Association South Section 5 Ishmael","Poise","Envy,Lust,Wrath","00"
"LCCB Assistant Manager Ishmael","Aggro,Rupture,Tremor","Gluttony,Gloom,Pride","00"
"Lobotomy E.G.O::Sloshing Ishmael","Aggro,Rupture,Tremor","Gloom,Wrath,Gluttony","00"
"Edgar Family Butler Ishmael","Poise,Sinking","Sloth,Gluttony,Gloom","00"
"R Corp. 4th Pack Reindeer Ishmael","Charge,Sinking","Gloom,Envy,Wrath","000"
"Liu Association South Section 4 Ishmael","Burn","Lust,Wrath,Envy","000"
"Molar Boatworks Fixer Ishmael","Sinking,Tremor","Pride,Sloth,Gloom","000"
"The Pequod Captain Ishmael","Aggro,Bleed,Burn","Envy,Pride,Wrath","000"
"Zwei Association West Section 3 Ishmael","Aggro,Tremor","Pride,Envy,Gluttony","000"
"Kurokumo Clan Captain Ishmael","Bleed","Envy,Pride,Lust","000"
"Family Hierarch Candidate Ishmael","Poise,Rupture","Gloom,Gluttony,Envy","000"
"LCB Sinner Rodion","Bleed","Gluttony,Pride,Wrath","0"
"LCCB Assistant Manager Rodion","","Pride,Gluttony,Envy","00"
"N Corp. Mittelhammer Rodion","Bleed","Pride,Lust,Wrath","00"
"Zwei Association South Section 5 Rodion","Aggro,Poise","Wrath,Sloth,Gloom","00"
"T Corp. Class 2 Collection Staff Rodion","Tremor","Envy,Wrath,Sloth","00"
"Kurokumo Clan Wakashu Rodion","Bleed,Poise","Gluttony,Lust,Pride","000"
"Rosespanner Workshop Rep Rodion","Charge,Tremor","Pride,Gloom,Envy","000"
"Dieci Association South Section 4 Rodion","Aggro,Discard,Sinking","Gloom,Envy,Sloth","000"
"Liu Association South Section 4 Director Rodion","Burn","Pride,Wrath,Lust","000"
"Devyat' Association North Section 3 Rodion","Rupture","Lust,Wrath,Gluttony","000"
"The Princess of La Manchaland Rodion","Bleed,Rupture","Pride,Envy,Lust","000"
"Heishou Pack - Si Branch Rodion","Poise,Rupture","Envy,Gluttony,Gloom","000"
"Lobotomy E.G.O::The Sword Sharpened with Tears Rodion","Sinking","Gloom,Envy,Pride","000"
"LCB Sinner Sinclair","Rupture","Pride,Wrath,Envy","0"
"Zwei Association South Section 6 Sinclair","Aggro,Tremor","Gloom,Wrath,Sloth","00"
"Los Mariachis Jefe Sinclair","Poise,Sinking","Sloth,Envy,Gloom","00"
"Lobotomy E.G.O::Red Sheet Sinclair","Rupture","Gluttony,Pride,Lust","00"
"Molar Boatworks Fixer Sinclair","Tremor","Gloom,Envy,Gluttony","00"
"Zwei Association West Section 3 Sinclair","Aggro,Tremor","Lust,Gloom,Sloth","00"
"Blade Lineage Salsu Sinclair","Bleed,Poise","Gluttony,Wrath,Pride","000"
"The One Who Shall Grip Sinclair","Bleed,Burn","Gloom,Lust,Wrath","000"
"Cinq Association South Section 4 Director Sinclair","Poise","Gluttony,Pride,Lust","000"
"Dawn Office Fixer Sinclair","Bleed","Gloom,Envy,Wrath","000"
"Devyat' Association North Section 3 Sinclair","Rupture","Lust,Gluttony,Wrath","000"
"The Middle Little Brother Sinclair","Aggro,Bleed","Lust,Gluttony,Wrath","000"
"The Thumb East Soldato II Sinclair","Ammo,Burn,Tremor","Lust,Sloth,Wrath","000"
"LCB Sinner Outis","Rupture","Sloth,Pride,Gloom","0"
"Blade Lineage Salsu Outis","Poise","Wrath,Lust,Pride","00"
"G Corp. Head Manager Outis","Sinking","Sloth,Gluttony,Gloom","00"
"Cinq Association South Section 4 Outis","Aggro,Poise","Pride,Gloom,Lust","00"
"The Ring Pointillist Student Outis","Bleed,Random","Lust,Wrath,Gluttony","00"
"Seven Association South Section 6 Director Outis","Rupture","Gluttony,Sloth,Lust","000"
"Molar Office Fixer Outis","Discard,Tremor","Wrath,Lust,Sloth","000"
"Lobotomy E.G.O::Magic Bullet Outis","Burn","Wrath,Pride,Pride","000"
"Wuthering Heights Chief Butler Outis","Sinking","Pride,Gloom,Lust","000"
"W Corp. L3 Cleanup Captain Outis","Charge,Rupture","Pride,Envy,Gloom","000"
"The Barber of La Manchaland Outis","Bleed","Gluttony,Lust,Wrath","000"
"Heishou Pack - Mao Branch Outis","Rupture","Sloth,Gluttony,Gloom","000"
"LCB Sinner Gregor","Rupture","Gloom,Gluttony,Sloth","0"
"Liu Association South Section 6 Gregor","Burn","Wrath,Lust,Sloth","00"
"R.B. Sous-chef Gregor","Bleed","Lust,Gluttony,Envy","00"
"Rosespanner Workshop Fixer Gregor","Rupture,Tremor","Gluttony,Envy,Gloom","00"
"Kurokumo Clan Captain Gregor","Bleed","Sloth,Lust,Gloom","00"
"G Corp. Manager Corporal Gregor","Rupture","Gluttony,Sloth,Lust","000"
"Zwei Association South Section 4 Gregor","Aggro","Sloth,Gluttony,Gloom","000"
"Twinhook Pirates First Mate Gregor","Ammo,Bleed,Poise","Sloth,Pride,Gloom","000"
"Edgar Family Heir Gregor","Sinking","Envy,Pride,Lust","000"
"The Priest of La Manchaland Gregor","Aggro,Bleed,Rupture","Gluttony,Pride,Lust","000"
"Firefist Office Survivor Gregor","Burn","Lust,Wrath,Wrath","000"
"Heishou Pack - Si Branch Gregor","Poise,Rupture","Pride,Gluttony,Envy","000"
`;
            const egoData = `Crow's Eye View Yi Sang - ZAYIN - Sloth - Yellow
Bygone Days Yi Sang - ZAYIN - Gloom - Blue
4th Match Flame Yi Sang - TETH - Wrath - Red
Wishing Cairn Yi Sang - TETH - Sloth - Yellow
Dimension Shredder Yi Sang - HE - Pride - Indigo
Fell Bullet Yi Sang - HE - Pride - Indigo
Sunshower Yi Sang - WAW - Sloth - Yellow
Representation Emitter Faust - ZAYIN - Pride - Indigo
Hex Nail Faust - TETH - Envy - Purple
9:2 Faust - TETH - Lust - Orange
Lasso Faust - TETH - Gluttony - Green
Fluid Sac Faust - HE - Gloom - Blue
Telepole Faust - HE - Envy - Purple
Thoracalgia Faust - HE - Pride - Indigo
Everlasting Faust - WAW - Sloth - Yellow
La Sangre de Sancho Don Quixote - ZAYIN - Lust - Orange
Lifetime Stew Don Quixote - TETH - Lust - Orange
Wishing Cairn Don Quixote - TETH - Sloth - Yellow
Electric Screaming Don Quixote - TETH - Envy - Purple
Fluid Sac Don Quixote - HE - Gloom - Blue
Telepole Don Quixote - HE - Envy - Purple
Red Sheet Don Quixote - HE - Gluttony - Green
Yearning-Mircalla Don Quixote - WAW - Lust - Orange
In the Name of Love and Hate Don Quixote - WAW - Envy - Purple
Forest for the Flames Ryōshū - ZAYIN - Lust - Orange
Soda Ryōshū - ZAYIN - Gloom - Blue
Red Eyes Ryōshū - TETH - Lust - Orange
Blind Obsession Ryōshū - TETH - Pride - Indigo
4th Match Flame Ryōshū - HE - Wrath - Red
Red Eyes (Open) Ryōshū - HE - Envy - Purple
Thoracalgia Ryōshū - HE - Pride - Indigo
Contempt, Awe Ryōshū - WAW - Lust - Orange
Chains of Others Meursault - ZAYIN - Pride - Indigo
Screwloose Wallop Meursault - TETH - Envy - Purple
Regret Meursault - TETH - Wrath - Red
Electric Screaming Meursault - TETH - Envy - Purple
Pursuance Meursault - HE - Sloth - Yellow
Capote Meursault - HE - Wrath - Red
Yearning-Mircalla Meursault - WAW - Lust - Orange
Land of Illusion Hong Lu - ZAYIN - Gloom - Blue
Roseate Desire Hong Lu - TETH - Lust - Orange
Soda Hong Lu - TETH - Gloom - Blue
Cavernous Wailing Hong Lu - TETH - Sloth - Yellow
Lasso Hong Lu - TETH - Gluttony - Green
Dimension Shredder Hong Lu - HE - Pride - Indigo
Effervescent Corrosion Hong Lu - HE - Gluttony - Green
Tears of the Tarnished Blood [汚血泣淚] Hong Lu - WAW - Gluttony - Green
Bodysack Heathcliff - ZAYIN - Envy - Purple
Holiday Heathcliff - ZAYIN - Gluttony - Green
AEDD Heathcliff - TETH - Gloom - Blue
Fell Bullet Heathcliff - TETH - Pride - Indigo
Telepole Heathcliff - HE - Envy - Purple
Ya Śūnyatā Tad Rūpam Heathcliff - HE - Lust - Orange
Asymmetrical Inertia Heathcliff - HE - Sloth - Yellow
Binds Heathcliff - WAW - Gloom - Blue
Snagharpoon Ishmael - ZAYIN - Gloom - Blue
Hundred-Footed Death Maggot [蝍蛆殺] Ishmael - ZAYIN - Gloom - Blue
Roseate Desire Ishmael - TETH - Lust - Orange
Capote Ishmael - TETH - Wrath - Red
Bygone Days Ishmael - TETH - Gloom - Blue
Ardor Blossom Star Ishmael - HE - Wrath - Red
Wingbeat Ishmael - HE - Gluttony - Green
Christmas Nightmare Ishmael - HE - Gluttony - Green
Blind Obsession Ishmael - WAW - Pride - Indigo
What is Cast Rodion - ZAYIN - Pride - Indigo
Rime Shank Rodion - TETH - Gloom - Blue
Effervescent Corrosion Rodion - TETH - Gluttony - Green
4th Match Flame Rodion - HE - Wrath - Red
Pursuance Rodion - HE - Sloth - Yellow
Hex Nail Rodion - HE - Envy - Purple
Sanguine Desire Rodion - HE - Lust - Orange
Indicant's Trial Rodion - WAW - Wrath - Red
Branch of Knowledge Sinclair - ZAYIN - Gluttony - Green
Cavernous Wailing Sinclair - ZAYIN - Gloom - Blue
Impending Day Sinclair - TETH - Wrath - Red
Lifetime Stew Sinclair - TETH - Lust - Orange
Hex Nail Sinclair - TETH - Envy - Purple
Lantern Sinclair - HE - Gluttony - Green
9:2 Sinclair - HE - Lust - Orange
Tears of the Tarnished Blood [汚血泣淚] Sinclair - WAW - Gluttony - Green
To Páthos Máthos Outis - ZAYIN - Pride - Indigo
Ya Śūnyatā Tad Rūpam Outis - WAW - Lust - Orange
Sunshower Outis - TETH - Gluttony - Green
Ebony Stem Outis - HE - Gluttony - Green
Holiday Outis - HE - Wrath - Red
Dimension Shredder Outis - HE - Envy - Purple
Magic Bullet Outis - HE - Pride - Indigo
Binds Outis - WAW - Pride - Indigo
Suddenly, One Day Gregor - ZAYIN - Sloth - Yellow
Legerdemain Gregor - ZAYIN - Gluttony - Green
Lantern Gregor - TETH - Gluttony - Green
Bygone Days Gregor - TETH - Gloom - Blue
AEDD Gregor - HE - Gloom - Blue
Solemn Lament Gregor - HE - Gloom - Blue
Christmas Nightmare Gregor - HE - Sloth - Yellow
Garden of Thorns Gregor - WAW - Lust - Orange`;
            
            cacheDOMElements();

            // Inject filter bars and set up listeners
            document.getElementById('global-filter-bar-roster').innerHTML = createFilterBarHTML({ showSinnerFilter: true });
            document.getElementById('global-filter-bar-builder').innerHTML = createFilterBarHTML({ showSinnerFilter: false });
            document.getElementById('global-filter-bar-draft').innerHTML = createFilterBarHTML({ showSinnerFilter: true });
            setupFilterBar('global-filter-bar-roster', state.filters);
            setupFilterBar('global-filter-bar-builder', state.filters);
            setupFilterBar('global-filter-bar-draft', state.draftFilters);

            state.masterIDList = parseIDCSV(idCsvData);
            state.masterEGOList = parseEGOData(egoData);

            // Pre-sort IDs by sinner for the new roster builder
            const sinnerOrder = ["Yi Sang", "Faust", "Don Quixote", "Ryōshū", "Meursault", "Hong Lu", "Heathcliff", "Ishmael", "Rodion", "Sinclair", "Outis", "Gregor"];
            state.idsBySinner = {};
            sinnerOrder.forEach(sinnerName => {
                state.idsBySinner[sinnerName] = state.masterIDList.filter(id => id.sinner === sinnerName);
            });

            setupEventListeners();
            connectWebSocket();
            switchView('mainPage');
        });
    </script>
</body>
</html>
