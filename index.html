<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limbus Company Draft System - Multiplayer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* General Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #8B0000;
            --primary-dark: #5a0000;
            --secondary: #4A0000;
            --accent: #FFD700;
            --text: #F0F0F0;
            --bg: #1a1a1d;
            --panel: #1E1E1E;
            --border: #333;
            --rarity-0: #cccccc;
            --rarity-00: #B22222;
            --rarity-000: #FFD700;
            --sin-wrath-bg: rgba(129,44,33,1);
            --sin-lust-bg: rgba(177,97,46,1);
            --sin-sloth-bg: rgba(226,136,3,1);
            --sin-gluttony-bg: rgba(125, 158, 5, 1);
            --sin-gloom-bg: rgba(45,102,116,1);
            --sin-pride-bg: rgba(22,81,131,1);
            --sin-envy-bg: rgba(94, 49, 122, 1);
            --connected: #4b8b3b;
            --disconnected: #a00;
            --warning: #ff8c00;
            --ready: #4b8b3b;
            --drafting: #4169e1;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.5s ease;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .hidden {
            display: none !important;
        }
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-size: 3.2rem;
            margin-bottom: 10px;
            color: var(--accent);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(to right, var(--accent), #ff8c00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }
        
        h2 {
            font-size: 2rem;
            margin: 15px 0;
            color: var(--accent);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 8px;
            text-align: center;
        }
        
        h3 {
            font-size: 1.4rem;
            color: var(--accent);
            margin-bottom: 15px;
        }
        
        h4 {
            font-size: 1.1rem;
            color: #ccc;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* Components */
        .card {
            background: rgba(30, 30, 30, 0.85);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.7);
            border: 1px solid var(--border);
            backdrop-filter: blur(5px);
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover:not(:disabled) { background: #ffc400; }
        .btn-secondary { background: #444; color: #fff; }
        .btn-secondary:hover:not(:disabled) { background: #555; }
        .btn-large { padding: 18px 35px; font-size: 1.3rem; }
        
        input, select {
            width: 100%;
            padding: 14px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: var(--text);
            font-size: 1.1rem;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);
        }
        
        /* Main Page */
        #main-page { text-align: center; max-width: 1200px; margin: 0 auto; }
        .action-container { display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; margin: 40px 0; }
        .action-card { flex: 1; min-width: 300px; max-width: 350px; background: rgba(74, 0, 0, 0.5); border-radius: 15px; padding: 30px; border-top: 4px solid var(--accent); display: flex; flex-direction: column; gap: 20px; transition: transform 0.3s; }
        .action-card:hover { transform: translateY(-10px); }
        .action-title { font-size: 1.8rem; color: var(--accent); }
        .action-description { font-size: 1.1rem; line-height: 1.6; flex-grow: 1; }
        .lobby-access { background: rgba(74, 0, 0, 0.6); border-radius: 15px; padding: 30px; margin: 40px auto; max-width: 600px; border: 1px solid var(--accent); box-shadow: 0 0 30px rgba(255, 215, 0, 0.2); }
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-size: 1.1rem; color: var(--accent); }
        .role-options { display: flex; gap: 15px; margin-top: 10px; }
        .role-option { flex: 1; text-align: center; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .role-option.selected { background: var(--primary); border-color: var(--accent); box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        .role-option i { font-size: 2rem; margin-bottom: 10px; color: var(--accent); }

        /* Lobby View */
        #lobby-view { display: none; }
        .lobby-info { display: flex; justify-content: space-between; align-items: center; background: var(--secondary); padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid var(--accent); }
        .code-display { font-family: monospace; font-size: 2rem; letter-spacing: 6px; padding: 12px 25px; background: #000; border-radius: 8px; color: var(--accent); border: 1px solid var(--accent); }
        .participants { display: flex; gap: 20px; font-size: 1.2rem; flex-wrap: wrap; justify-content: center; }
        .participant { background: var(--primary); padding: 10px 20px; border-radius: 25px; display: flex; align-items: center; gap: 10px; transition: transform 0.3s; }
        .participant.current-user { background: var(--primary-dark); border: 2px solid var(--accent); }
        .back-button { position: absolute; top: 20px; left: 20px; z-index: 10; }
        
        /* Player Panels & Draft Area */
        .player-area { display: flex; gap: 15px; flex-wrap: wrap; }
        .player-panel { flex: 1; min-width: 280px; background: var(--secondary); border-radius: 10px; padding: 15px; border-top: 4px solid var(--accent); transition: all 0.3s ease; position: relative; }
        .player-panel.locked::after { content: 'LOCKED'; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--accent); font-weight: bold; z-index: 5; border-radius: 10px; backdrop-filter: blur(2px); }
        .player-panel.draft-active { box-shadow: 0 0 15px var(--accent); border: 2px solid var(--accent); transform: scale(1.02); }
        .player-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .player-name { font-size: 1.4rem; font-weight: bold; color: var(--accent); }
        .player-status { padding: 3px 10px; border-radius: 20px; font-size: 0.9rem; }
        .controls { display: flex; justify-content: space-around; align-items: center; gap: 10px; margin-top: 20px; }
        .roster-load-form { display: flex; gap: 10px; align-items: center; margin-top: 10px; }

        /* ID & EGO Item Styles */
        .id-item, .ego-item { cursor: pointer; transition: all 0.2s ease; }
        .id-item:hover, .ego-item:hover { transform: scale(1.03); border-color: var(--accent); }
        .roster-selection, .ban-list, .pick-list, .builder-id-pool, .builder-selected-roster { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; padding: 10px; background: rgba(0, 0, 0, 0.2); border-radius: 8px; overflow-y: auto; align-content: start; }
        .roster-selection, .builder-id-pool { max-height: 500px; }
        .id-item { padding: 8px; background: rgba(139, 0, 0, 0.3); border-radius: 4px; display: flex; align-items: center; gap: 10px; border-left: 4px solid transparent; }
        .id-item.rarity-0 { border-left-color: var(--rarity-0); }
        .id-item.rarity-00 { border-left-color: var(--rarity-00); }
        .id-item.rarity-000 { border-left-color: var(--rarity-000); }
        .id-item.selected { background: var(--primary); border-color: var(--accent) !important; }
        .id-icon { width: 60px; height: 60px; border-radius: 5px; background-size: cover; background-position: center; flex-shrink: 0; border: 1px solid var(--border); }
        .id-name { flex-grow: 1; font-size: 0.95rem; display: flex; align-items: center; min-height: 2.5em; line-height: 1.25; }
        
        /* Statuses & Notifications */
        .status-ready { background: var(--ready) !important; color: #fff !important; }
        .status-drafting { background: var(--drafting) !important; color: #fff !important; }
        .status-waiting { background: #a0a0a0 !important; color: #fff !important; }
        #draft-status-panel { background: rgba(255, 215, 0, 0.1); border: 1px solid var(--accent); padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center; }
        #current-phase { font-size: 1.5rem; margin-bottom: 10px; }
        #draft-action-description { font-size: 1.1rem; color: var(--text); min-height: 24px; }
        .connection-status { position: fixed; top: 10px; right: 10px; padding: 8px 15px; border-radius: 20px; font-weight: bold; background: var(--disconnected); color: #fff; display: flex; align-items: center; gap: 8px; z-index: 1000; }
        .connection-status.connected { background: var(--connected); }
        .notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 15px 25px; background: var(--primary); border-radius: 8px; color: white; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; opacity: 0; transition: all 0.3s; }
        .notification.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; z-index: 2000; backdrop-filter: blur(5px); }
        
        /* Filter Bar */
        .filter-bar { display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 20px; }
        .filter-group { flex: 1; min-width: 150px; }
        .filter-label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: #ccc; }

        /* EGO Ban Phase */
        .ego-ban-layout { display: flex; gap: 20px; align-items: flex-start; }
        #ego-selection-window, #opponent-roster-display { flex: 1; background: var(--panel); padding: 15px; border-radius: 10px; border: 1px solid var(--border); }
        .ego-ban-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; max-height: 75vh; overflow-y: auto; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .ego-item { display: flex; flex-direction: column; padding: 10px; border-radius: 8px; border: 2px solid transparent; color: #111; }
        .ego-item.banned { opacity: 0.4; cursor: not-allowed; background-color: #333 !important; color: #999; transform: none !important; }
        .ego-header { display: flex; justify-content: flex-end; font-weight: bold; margin-bottom: 5px; }
        .ego-rarity { padding: 2px 6px; border-radius: 4px; background-color: rgba(0,0,0,0.2); color: #fff; }
        .ego-name { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; flex-grow: 1; }
        .banned-egos-display { background: var(--panel); padding: 15px; border-radius: 10px; margin: 20px 0; border: 1px solid var(--border); }
        .banned-egos-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .banned-ego-item { padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; text-align: center; color: #111; }
        .banned-ego-item .rarity { font-weight: bold; margin-right: 5px; background: rgba(0,0,0,0.2); padding: 2px 4px; border-radius: 3px; color: #fff; }
        .banned-ego-item .name { text-decoration: line-through; }

        /* Roster Builder & Completed View */
        #roster-builder-page, #completed-view { display: none; }
        #roster-builder-page .card { display: flex; gap: 20px; flex-wrap: wrap; }
        .builder-main-panel { flex: 3; min-width: 400px; }
        .builder-side-panel { flex: 2; min-width: 300px; background: var(--secondary); padding: 20px; border-radius: 10px; align-self: flex-start;}
        .final-rosters-container { display: flex; gap: 30px; margin: 30px 0; flex-wrap: wrap; justify-content: center; }
        .final-player-panel { flex: 1; min-width: 400px; max-width: 500px; background: var(--panel); border-radius: 15px; padding: 20px; border: 1px solid var(--border); border-top: 4px solid var(--primary); }
        .final-picks, .final-bans { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; margin-top: 15px; }
        .final-bans .id-item { background: rgba(100, 0, 0, 0.4); opacity: 0.8; }
        .final-bans .id-name { text-decoration: line-through; }

        /* Responsive */
        @media (max-width: 1200px) {
            #roster-builder-page .card, .ego-ban-layout { flex-direction: column; }
        }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .action-container, .lobby-info, .phase-container { flex-direction: column; align-items: center; }
            h1 { font-size: 2.5rem; }
            .code-display { font-size: 1.5rem; letter-spacing: 4px; }
            .role-options { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin"></i>&nbsp;&nbsp;Loading Game Data...
    </div>

    <div class="connection-status" id="connection-status">
        <i class="fas fa-plug"></i>
        <span>Connecting...</span>
    </div>
 
    <div class="notification" id="notification"></div>

    <div class="container">
        <!-- Main Page View -->
        <div id="main-page">
            <header>
                <h1><i class="fas fa-dragon"></i> Limbus Company Draft System</h1>
                <p>Organize and participate in competitive drafting sessions</p>
            </header>
            
            <div class="form-group" style="max-width: 400px; margin: 30px auto; text-align: left;">
                <label for="player-name">Your Display Name</label>
                <input type="text" id="player-name" placeholder="Enter your name">
            </div>
            
            <div class="action-container">
                <div class="action-card">
                    <h3 class="action-title"><i class="fas fa-users-cog"></i> Roster Builder</h3>
                    <p class="action-description">Create a 42-ID roster and generate a shareable code for quick loading during a match.</p>
                    <button class="btn btn-secondary btn-large" id="go-to-builder"><i class="fas fa-wrench"></i> Open Builder</button>
                </div>

                <div class="action-card">
                    <h3 class="action-title"><i class="fas fa-plus-circle"></i> Create New Lobby</h3>
                    <p class="action-description">Start a new drafting session as the referee. You'll get a unique lobby code to share with players.</p>
                    <button class="btn btn-primary btn-large" id="create-lobby"><i class="fas fa-plus"></i> Create Lobby</button>
                </div>
                
                <div class="action-card">
                    <h3 class="action-title"><i class="fas fa-sign-in-alt"></i> Join Existing Lobby</h3>
                    <p class="action-description">Join a lobby using a code provided by the referee. Select your role before entering.</p>
                    <button class="btn btn-large" id="join-lobby-toggle"><i class="fas fa-door-open"></i> Join Lobby</button>
                </div>
            </div>
            
            <div class="lobby-access hidden" id="lobby-access-form">
                <h2>Enter Lobby Details</h2>
                <div class="form-group">
                    <label for="lobby-code">Lobby Code:</label>
                    <input type="text" id="lobby-code" placeholder="Enter 6-character code" maxlength="6">
                </div>
                <div class="form-group">
                    <label>Select Your Role:</label>
                    <div class="role-options">
                        <div class="role-option" data-role="p1"><i class="fas fa-user"></i><div>Player 1</div></div>
                        <div class="role-option" data-role="p2"><i class="fas fa-user"></i><div>Player 2</div></div>
                        <div class="role-option" data-role="ref"><i class="fas fa-star"></i><div>Referee</div></div>
                    </div>
                </div>
                <button class="btn btn-primary btn-large" id="enter-lobby"><i class="fas fa-play"></i> Enter Lobby</button>
            </div>
        </div>
        
        <!-- Lobby View -->
        <div id="lobby-view">
            <button class="btn back-button" id="back-to-main-lobby"><i class="fas fa-arrow-left"></i> Main Menu</button>
            <header>
                <h1><i class="fas fa-dragon"></i> Drafting Session</h1>
            </header>
            
            <div class="card">
                <div class="lobby-info">
                    <div>
                        <h3>LOBBY CODE</h3>
                        <div class="code-display" id="lobby-code-display"></div>
                    </div>
                    <div>
                        <h3>PARTICIPANTS</h3>
                        <div class="participants" id="participants-list"></div>
                    </div>
                </div>
                
                <div id="draft-status-panel">
                    <h3 id="current-phase">Waiting for draft to start...</h3>
                    <p id="draft-action-description"></p>
                </div>

                <!-- Roster Selection Phase -->
                <div id="roster-phase" class="phase-section">
                    <h2>Roster Selection Phase</h2>
                    <p>Each player must select 42 IDs. When both are ready, the Referee can start the EGO Ban phase.</p>
                    <div class="filter-bar" id="global-filter-bar-roster"></div>
                    <div class="player-area">
                        <div class="player-panel" id="p1-panel">
                            <div class="player-header">
                                <div class="player-name" id="p1-name-display">Player 1</div>
                                <div class="player-status status-waiting" id="p1-status">Selecting</div>
                            </div>
                            <div class="counter"><i class="fas fa-users"></i> Selected: <strong id="p1-counter">0</strong> / 42</div>
                            <div class="roster-load-form">
                                <input type="text" id="p1-roster-code-input" placeholder="Paste Roster Code...">
                                <button class="btn btn-secondary" id="p1-roster-load"><i class="fas fa-upload"></i> Load</button>
                            </div>
                            <div class="roster-selection" id="p1-roster"></div>
                            <div class="controls">
                                <button class="btn" id="p1-random"><i class="fas fa-random"></i></button>
                                <button class="btn" id="p1-clear"><i class="fas fa-trash"></i></button>
                                <button class="btn" id="p1-ready"><i class="fas fa-check"></i> Ready</button>
                            </div>
                        </div>
                        <div class="player-panel" id="p2-panel">
                            <div class="player-header">
                                <div class="player-name" id="p2-name-display">Player 2</div>
                                <div class="player-status status-waiting" id="p2-status">Selecting</div>
                            </div>
                            <div class="counter"><i class="fas fa-users"></i> Selected: <strong id="p2-counter">0</strong> / 42</div>
                            <div class="roster-load-form">
                                <input type="text" id="p2-roster-code-input" placeholder="Paste Roster Code...">
                                <button class="btn btn-secondary" id="p2-roster-load"><i class="fas fa-upload"></i> Load</button>
                            </div>
                            <div class="roster-selection" id="p2-roster"></div>
                            <div class="controls">
                                <button class="btn" id="p2-random"><i class="fas fa-random"></i></button>
                                <button class="btn" id="p2-clear"><i class="fas fa-trash"></i></button>
                                <button class="btn" id="p2-ready"><i class="fas fa-check"></i> Ready</button>
                            </div>
                        </div>
                    </div>
                    <div class="ref-actions" style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary btn-large" id="start-ego-ban" disabled><i class="fas fa-ban"></i> Start EGO Bans</button>
                    </div>
                </div>

                <!-- EGO Ban Phase -->
                <div id="ego-ban-phase" class="phase-section hidden">
                    <div class="ego-ban-layout">
                        <div id="ego-selection-window">
                            <h3>Available EGOs</h3>
                            <div class="filter-bar">
                                <div class="filter-group" style="flex-grow: 2;">
                                    <label class="filter-label" for="ego-search-input">Search EGOs:</label>
                                    <input type="text" id="ego-search-input" placeholder="Search by name or sinner...">
                                </div>
                            </div>
                            <div class="ego-ban-container" id="ego-ban-container"></div>
                        </div>
                        <div id="opponent-roster-display">
                            <h3 id="opponent-roster-title">Opponent's Roster</h3>
                            <div class="roster-selection" id="opponent-roster-list"></div>
                        </div>
                    </div>
                </div>

                <!-- ID Draft Phase -->
                <div id="id-draft-phase" class="player-section hidden">
                    <div class="banned-egos-display" id="draft-banned-egos">
                        <h3><i class="fas fa-ban"></i> Banned EGOs</h3>
                        <div class="banned-egos-list" id="draft-banned-egos-list"></div>
                    </div>
                    <div class="filter-bar" id="global-filter-bar-draft"></div>
                    <div class="player-area">
                         <div class="player-panel" id="p1-draft-panel">
                            <div class="player-header">
                                <div class="player-name" id="p1-draft-name">Player 1</div>
                                <div class="player-status status-waiting" id="p1-draft-status">Waiting</div>
                            </div>
                            <div class="roster-selection" id="p1-draft-selection"></div>
                            <h4>Your Bans:</h4><div class="ban-list" id="p1-id-bans"></div>
                            <h4>Picked IDs:</h4><div class="pick-list" id="p1-picks"></div>
                        </div>
                        <div class="player-panel" id="p2-draft-panel">
                            <div class="player-header">
                                <div class="player-name" id="p2-draft-name">Player 2</div>
                                <div class="player-status status-waiting" id="p2-draft-status">Waiting</div>
                            </div>
                            <div class="roster-selection" id="p2-draft-selection"></div>
                            <h4>Your Bans:</h4><div class="ban-list" id="p2-id-bans"></div>
                            <h4>Picked IDs:</h4><div class="pick-list" id="p2-picks"></div>
                        </div>
                    </div>
                    <div class="ref-actions" style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-primary" id="complete-draft" disabled><i class="fas fa-flag-checkered"></i> Complete Draft</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Roster Builder Page -->
        <div id="roster-builder-page">
            <button class="btn back-button" id="back-to-main-builder"><i class="fas fa-arrow-left"></i> Main Menu</button>
            <header>
                <h1><i class="fas fa-users-cog"></i> Roster Builder</h1>
                <p>Create a roster and generate a shareable code.</p>
            </header>
            <div class="card">
                <div class="builder-main-panel">
                    <h3>Available Identities</h3>
                     <div class="filter-bar" id="global-filter-bar-builder"></div>
                     <div class="builder-id-pool" id="builder-id-pool"></div>
                </div>
                <div class="builder-side-panel">
                    <h3>Your Roster (<span id="builder-counter">0</span>/42)</h3>
                    <div class="builder-selected-roster" id="builder-selected-roster"></div>
                    <div class="controls" style="margin-top: 10px;">
                        <button class="btn" id="builder-random"><i class="fas fa-random"></i> Random</button>
                        <button class="btn" id="builder-clear"><i class="fas fa-trash"></i> Clear</button>
                    </div>
                    <h3 style="margin-top: 20px;">Roster Code</h3>
                    <div id="builder-roster-code-display" style="background: #111; padding: 10px; border-radius: 5px; font-family: monospace; min-height: 50px; margin-top: 10px; word-wrap: break-word;"></div>
                    <button class="btn btn-primary" id="builder-copy-code" style="width: 100%; margin-top: 10px;" disabled><i class="fas fa-copy"></i> Copy Code</button>
                    
                    <h3 style="margin-top: 20px;">Load from Code</h3>
                    <div class="roster-load-form">
                        <input type="text" id="builder-load-code-input" placeholder="Paste code here...">
                        <button class="btn" id="builder-load-code"><i class="fas fa-upload"></i> Load</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Draft View -->
        <div id="completed-view">
            <header>
                <h1><i class="fas fa-flag-checkered"></i> Draft Complete</h1>
                <p>Final Rosters</p>
            </header>
            <div class="banned-egos-display" id="final-banned-egos">
                <h3><i class="fas fa-ban"></i> Banned EGOs</h3>
                <div class="banned-egos-list" id="final-banned-egos-list"></div>
            </div>
            <div class="final-rosters-container">
                <div class="final-player-panel">
                    <h2 id="final-p1-name">Player 1's Roster</h2>
                    <div class="final-picks" id="final-p1-picks"></div>
                    <h3>Banned from Roster</h3>
                    <div class="final-bans" id="final-p1-bans"></div>
                </div>
                <div class="final-player-panel">
                    <h2 id="final-p2-name">Player 2's Roster</h2>
                    <div class="final-picks" id="final-p2-picks"></div>
                    <h3>Banned from Roster</h3>
                    <div class="final-bans" id="final-p2-bans"></div>
                </div>
            </div>
            <button class="btn btn-large btn-primary" id="restart-draft"><i class="fas fa-redo"></i> Start New Draft</button>
        </div>
    </div>

    <script>
        // ======================
        // CONSTANTS & CONFIG
        // ======================
        const ROSTER_SIZE = 42;
        const EGO_BAN_COUNT = 5;
        
        // ======================
        // APPLICATION STATE
        // ======================
        const state = {
            isDataLoaded: false,
            currentView: "main",
            lobbyCode: "",
            userRole: "",
            participants: {},
            roster: { p1: [], p2: [] },
            builderRoster: [],
            masterIDList: [],
            masterEGOList: [],
            draft: {},
            filters: { sinner: "", sinAffinity: "", keyword: "", rosterSearch: "" },
            draftFilters: { sinner: "", sinAffinity: "", keyword: "", rosterSearch: "" },
            egoSearch: "",
            socket: null,
        };

        // This will be populated once the DOM is loaded
        let elements = {};

        // ======================
        // UTILITY & CORE
        // ======================
        function showNotification(text, isError = false) {
            elements.notification.textContent = text;
            elements.notification.style.background = isError ? 'var(--disconnected)' : 'var(--primary)';
            elements.notification.classList.add('show');
            setTimeout(() => { elements.notification.classList.remove('show'); }, 3000);
        }

        function createSlug(name) {
            if (!name) return '';
            return name.toLowerCase()
                .replace(/ryōshū/g, 'ryshu').replace(/öufi/g, 'ufi')
                .replace(/e\.g\.o::/g, 'ego-')
                .replace(/ & /g, ' ').replace(/[.'"]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').replace(/[^\w-]+/g, '');
        }
        
        // ======================
        // DATA HANDLING (Roster Code)
        // ======================
        function generateRosterCode() {
            if (state.builderRoster.length !== ROSTER_SIZE || !state.isDataLoaded) return null;
            try {
                const indices = state.builderRoster.map(slug => {
                    const index = state.masterIDList.findIndex(id => id.id === slug);
                    return index > -1 ? index : 255; // Use 255 as an error marker
                });
                const uint8Array = new Uint8Array(indices);
                const binaryString = String.fromCharCode.apply(null, uint8Array);
                return btoa(binaryString).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, ''); // URL-safe base64
            } catch (e) {
                console.error("Error generating roster code:", e);
                return null;
            }
        }

        function loadRosterFromCode(code) {
            if (!state.isDataLoaded) return null;
            try {
                let base64 = code.replace(/-/g, '+').replace(/_/g, '/');
                while (base64.length % 4) { base64 += '='; }
                const binaryString = atob(base64);

                if (binaryString.length !== ROSTER_SIZE) {
                    showNotification("Invalid roster code: incorrect length.", true);
                    return null;
                }
                const uint8Array = new Uint8Array(binaryString.split('').map(c => c.charCodeAt(0)));
                const rosterSlugs = Array.from(uint8Array).map(index => {
                    return (index < state.masterIDList.length) ? state.masterIDList[index].id : null;
                }).filter(Boolean);

                if (rosterSlugs.length !== ROSTER_SIZE) {
                    showNotification("Invalid roster code: contains invalid ID data.", true);
                    return null;
                }
                return rosterSlugs;
            } catch (e) {
                console.error("Error decoding roster code:", e);
                showNotification("Invalid roster code format.", true);
                return null;
            }
        }

        // ======================
        // SOCKET COMMUNICATION
        // ======================
        function connectWebSocket() {
            const loc = window.location;
            const wsProtocol = loc.protocol === 'https:' ? 'wss:' : 'ws:';
            const remoteUrl = `${wsProtocol}//${loc.host}/`;
            state.socket = new WebSocket(remoteUrl);

            state.socket.onopen = () => {
                elements.connectionStatus.innerHTML = '<i class="fas fa-check"></i> <span>Connected</span>';
                elements.connectionStatus.classList.add('connected');
            };
            state.socket.onmessage = (event) => handleServerMessage(JSON.parse(event.data));
            state.socket.onclose = () => {
                elements.connectionStatus.innerHTML = '<i class="fas fa-plug"></i> <span>Disconnected</span>';
                elements.connectionStatus.classList.remove('connected');
                showNotification("Connection lost. Please refresh.", true);
            };
            state.socket.onerror = (error) => console.error('WebSocket error:', error);
        }
        
        function sendMessage(message) {
            if (state.socket && state.socket.readyState === WebSocket.OPEN) {
                state.socket.send(JSON.stringify(message));
            } else {
                showNotification("Not connected to server.", true);
            }
        }
        
        function handleServerMessage(message) {
            console.log("Received from server:", message);
            switch (message.type) {
                case 'init': handleInit(message); break;
                case 'lobbyCreated': handleLobbyCreated(message); break;
                case 'lobbyJoined': handleLobbyJoined(message); break;
                case 'stateUpdate': handleStateUpdate(message); break;
                case 'notification': showNotification(message.text); break;
                case 'error': showNotification(`Error: ${message.message}`, true); break;
            }
        }

        // ======================
        // UI RENDERING & DOM MANIPULATION
        // ======================
        function createIdElement(idData, options = {}) {
            const { isSelected, clickHandler } = options;
            const idElement = document.createElement('div');
            idElement.className = `id-item rarity-${idData.rarity} ${isSelected ? 'selected' : ''}`;
            idElement.dataset.id = idData.id;
            idElement.innerHTML = `<div class="id-icon" style="background-image: url('uploads/${idData.imageFile}')"></div><div class="id-name">${idData.name}</div>`;
            if (clickHandler) {
                idElement.addEventListener('click', () => clickHandler(idData.id));
            }
            return idElement;
        }

        function createEgoElement(egoData, clickHandler) {
            const egoElement = document.createElement('div');
            const allBans = [...(state.draft.egoBans.p1 || []), ...(state.draft.egoBans.p2 || [])];
            const isBanned = allBans.includes(egoData.id);

            egoElement.className = `ego-item ${isBanned ? 'banned' : ''}`;
            egoElement.dataset.id = egoData.id;
            egoElement.style.backgroundColor = egoData.cssColor;

            egoElement.innerHTML = `
                <div class="ego-header"><span class="ego-rarity">${egoData.rarity}</span></div>
                <div class="ego-name">${egoData.name}</div>`;
            
            if (clickHandler && !isBanned) {
                egoElement.addEventListener('click', () => clickHandler(egoData.id));
            }
            return egoElement;
        }

        function renderIDList(container, idObjectList, selectionSet, clickHandler) {
            container.innerHTML = '';
            if (!Array.isArray(idObjectList) || idObjectList.length === 0) {
                if(!container.classList.contains('ban-list') && !container.classList.contains('pick-list')) {
                   container.innerHTML = '<div style="padding: 10px; text-align: center; grid-column: 1 / -1;">No items to display.</div>';
                }
                return;
            }
            
            const fragment = document.createDocumentFragment();
            idObjectList.forEach(idData => {
                if (!idData) return;
                const isSelected = selectionSet ? selectionSet.includes(idData.id) : false;
                const element = createIdElement(idData, { isSelected, clickHandler });
                fragment.appendChild(element);
            });
            container.appendChild(fragment);
        }
        
        function switchView(view) {
            state.currentView = view;
            ['mainPage', 'lobbyView', 'completedView', 'rosterBuilderPage'].forEach(pageId => {
                elements[pageId].classList.toggle('hidden', pageId !== view);
            });
        }

        function updateAllUIsFromState() {
            if (!state.isDataLoaded || !state.lobbyCode) return;
            
            const { phase } = state.draft;

            // View switching based on phase
            if (phase === 'complete') {
                switchView('completedView');
                renderCompletedView();
                return;
            }
            switchView('lobbyView');

            // Toggle phase sections
            elements.rosterPhase.classList.toggle('hidden', phase !== 'roster');
            elements.egoBanPhase.classList.toggle('hidden', phase !== 'egoBan');
            const isDraftPhase = ['ban', 'pick', 'midBan', 'pick2'].includes(phase);
            elements.idDraftPhase.classList.toggle('hidden', !isDraftPhase);

            // Participants list
            elements.participantsList.innerHTML = '';
            ['p1', 'p2', 'ref'].forEach(role => {
                const p = state.participants[role];
                if (!p) return;
                const displayName = state.userRole === role ? `${p.name} (You)` : p.name;
                const el = document.createElement('div');
                el.className = `participant ${state.userRole === role ? 'current-user' : ''}`;
                const icon = role === 'ref' ? 'fa-star' : 'fa-user';
                let statusIcon = '<i class="fas fa-times-circle" style="color:var(--disconnected);"></i>';
                if (p.status === 'connected') {
                    statusIcon = (role !== 'ref' && p.ready) ? `<i class="fas fa-check-circle" style="color:var(--ready);"></i>` : `<i class="fas fa-dot-circle" style="color:var(--connected);"></i>`;
                }
                el.innerHTML = `<i class="fas ${icon}"></i> ${displayName} ${statusIcon}`;
                elements.participantsList.appendChild(el);
            });

            // Roster Phase UI
            if (phase === 'roster') {
                ['p1', 'p2'].forEach(player => {
                    const pData = state.participants[player];
                    const pRoster = state.roster[player];
                    elements[`${player}NameDisplay`].textContent = pData.name;
                    elements[`${player}Counter`].textContent = pRoster.length;
                    const isReady = pData.ready;
                    elements[`${player}Ready`].innerHTML = isReady ? '<i class="fas fa-times"></i> Unready' : `<i class="fas fa-check"></i> Ready`;
                    elements[`${player}Ready`].classList.toggle('btn-ready', isReady);
                    elements[`${player}Status`].textContent = isReady ? 'Ready' : 'Selecting';
                    elements[`${player}Status`].className = `player-status ${isReady ? 'status-ready' : 'status-waiting'}`;
                    elements[`${player}Panel`].classList.toggle('locked', isReady);
                    
                    const canInteract = state.userRole === player || state.userRole === 'ref';
                    elements[`${player}Random`].disabled = !canInteract || isReady;
                    elements[`${player}Clear`].disabled = !canInteract || isReady;
                    elements[`${player}Ready`].disabled = !canInteract;
                    elements[`${player}RosterCodeInput`].disabled = !canInteract || isReady;
                    elements[`${player}RosterLoad`].disabled = !canInteract || isReady;
                });
                filterAndRenderRosterSelection();
            }
            
            if (phase === 'egoBan') renderEgoBanPhase();
            if (isDraftPhase) updateDraftUI();
            
            updateDraftInstructions();
            checkPhaseReadiness();
        }
        
        function filterAndRenderRosterSelection() {
            const filteredList = filterIDs(state.masterIDList, state.filters);
            const canSelectP1 = (state.userRole === 'p1' || state.userRole === 'ref') && !state.participants.p1?.ready;
            const canSelectP2 = (state.userRole === 'p2' || state.userRole === 'ref') && !state.participants.p2?.ready;
            renderIDList(elements.p1Roster, filteredList, state.roster.p1, canSelectP1 ? (id) => sendMessage({ type: 'rosterSelect', lobbyCode: state.lobbyCode, player: 'p1', id }) : null);
            renderIDList(elements.p2Roster, filteredList, state.roster.p2, canSelectP2 ? (id) => sendMessage({ type: 'rosterSelect', lobbyCode: state.lobbyCode, player: 'p2', id }) : null);
        }

        function filterIDs(sourceList, filterObject) {
            const searchTerm = filterObject.rosterSearch.toLowerCase();
            return sourceList.filter(fullData => {
                if (!fullData) return false;
                if (filterObject.sinner && fullData.sinner !== filterObject.sinner) return false;
                if (filterObject.sinAffinity && !fullData.sinAffinities.includes(filterObject.sinAffinity)) return false;
                if (filterObject.keyword && !fullData.keywords.includes(filterObject.keyword)) return false;
                if (searchTerm && !fullData.name.toLowerCase().includes(searchTerm)) return false;
                return true;
            });
        }
        
        function renderEgoBanPhase() {
            const { currentPlayer } = state.draft;
            const opponent = currentPlayer === 'p1' ? 'p2' : 'p1';

            // Render EGOs
            const container = elements.egoBanContainer;
            container.innerHTML = '';
            const fragment = document.createDocumentFragment();
            const clickHandler = (state.userRole === currentPlayer || state.userRole === 'ref') ? (egoId) => sendMessage({ type: 'egoBan', lobbyCode: state.lobbyCode, egoId }) : null;
            
            const searchTerm = state.egoSearch.toLowerCase();
            const filteredEgos = state.masterEGOList.filter(ego => !searchTerm || ego.name.toLowerCase().includes(searchTerm));

            filteredEgos.forEach(ego => fragment.appendChild(createEgoElement(ego, clickHandler)));
            container.appendChild(fragment);

            // Render Opponent Roster
            elements.opponentRosterTitle.textContent = `${state.participants[opponent]?.name}'s Roster`;
            const opponentRosterObjects = state.roster[opponent].map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
            renderIDList(elements.opponentRosterList, opponentRosterObjects, null, null);
        }

        function renderBannedEgosDisplay() {
            const allBans = [...(state.draft.egoBans.p1 || []), ...(state.draft.egoBans.p2 || [])];
            const bannedEgoObjects = allBans.map(id => state.masterEGOList.find(ego => ego.id === id)).filter(Boolean);
            
            const renderList = (container) => {
                container.innerHTML = '';
                if (bannedEgoObjects.length === 0) {
                    container.innerHTML = '<li>No EGOs banned.</li>';
                    return;
                }
                bannedEgoObjects.forEach(ego => {
                    const item = document.createElement('div');
                    item.className = 'banned-ego-item';
                    item.style.backgroundColor = ego.cssColor;
                    item.innerHTML = `<span class="rarity">[${ego.rarity}]</span> <span class="name">${ego.name}</span>`;
                    container.appendChild(item);
                });
            };

            renderList(elements.draftBannedEgosList);
            renderList(elements.finalBannedEgosList);
        }

        function updateDraftUI() {
            const renderIdSublist = (container, idList) => {
                const idObjects = idList.map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
                renderIDList(container, idObjects, null, null);
            };
            
            renderIdSublist(elements.p1IdBans, state.draft.idBans.p2); // P1 bans from P2's roster
            renderIdSublist(elements.p2IdBans, state.draft.idBans.p1); // P2 bans from P1's roster
            renderIdSublist(elements.p1Picks, state.draft.picks.p1);
            renderIdSublist(elements.p2Picks, state.draft.picks.p2);
            
            const { currentPlayer } = state.draft;
            elements.p1DraftStatus.textContent = currentPlayer === "p1" ? "Drafting" : "Waiting";
            elements.p2DraftStatus.textContent = currentPlayer === "p2" ? "Drafting" : "Waiting";
            elements.p1DraftStatus.className = `player-status ${currentPlayer === "p1" ? "status-drafting" : "status-waiting"}`;
            elements.p2DraftStatus.className = `player-status ${currentPlayer === "p2" ? "status-drafting" : "status-waiting"}`;
            elements.p1DraftPanel.classList.toggle('draft-active', currentPlayer === 'p1');
            elements.p2DraftPanel.classList.toggle('draft-active', currentPlayer === 'p2');

            renderBannedEgosDisplay();
        }

        function updateDraftInstructions() {
            let phaseText = "", actionDesc = "";
            const { phase, currentPlayer, actionCount } = state.draft;
            const canInteract = state.userRole === currentPlayer || state.userRole === 'ref';

            elements.p1DraftSelection.innerHTML = '';
            elements.p2DraftSelection.innerHTML = '';

            switch(phase) {
                case "roster": 
                    phaseText = "Roster Selection";
                    actionDesc = "Players select 42 IDs. Referee starts the draft when both are ready.";
                    break;
                case "egoBan":
                    phaseText = `EGO Ban Phase - ${state.participants[currentPlayer]?.name}'s turn`;
                    actionDesc = `Select ${actionCount} more EGO(s) to ban from the global pool.`;
                    break;
                case "ban": 
                case "midBan":
                    phaseText = `${phase === 'ban' ? 'Ban Phase' : 'Mid-Ban Phase'}`;
                    actionDesc = `${state.participants[currentPlayer]?.name} to ban ${actionCount} ID(s) from opponent's roster.`; 
                    break;
                case "pick": 
                case "pick2":
                    phaseText = `${phase === 'pick' ? 'Pick Phase 1' : 'Pick Phase 2'}`;
                    actionDesc = `${state.participants[currentPlayer]?.name} to pick ${actionCount} ID(s) from their available roster.`; 
                    break;
                case "complete":
                    phaseText = "Draft Completed!";
                    actionDesc = "All picks and bans are finalized.";
                    break;
                default:
                    phaseText = "Waiting for draft to start...";
            }

            if (['ban', 'pick', 'midBan', 'pick2'].includes(phase)) {
                const opponent = currentPlayer === 'p1' ? 'p2' : 'p1';
                const isBanAction = phase.includes('ban');
                
                const sourcePool = isBanAction ? state.draft.available[opponent] : state.draft.available[currentPlayer];
                let availableObjects = sourcePool.map(id => state.masterIDList.find(item => item && item.id === id)).filter(Boolean);
                availableObjects = filterIDs(availableObjects, state.draftFilters);
                
                const selectionContainer = currentPlayer === 'p1' ? elements.p1DraftSelection : elements.p2DraftSelection;
                const clickHandler = canInteract ? (id) => sendMessage({ type: 'draftSelect', lobbyCode: state.lobbyCode, payload: { id } }) : null;
                renderIDList(selectionContainer, availableObjects, [], clickHandler);
            }
            
            elements.currentPhase.textContent = phaseText;
            elements.draftActionDescription.textContent = actionDesc;
        }

        function renderCompletedView() {
            const renderFinalList = (container, idList) => {
                const idObjects = idList.map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
                renderIDList(container, idObjects, null, null);
            };
            elements.finalP1Name.textContent = `${state.participants.p1.name}'s Roster`;
            elements.finalP2Name.textContent = `${state.participants.p2.name}'s Roster`;
            renderFinalList(elements.finalP1Picks, state.draft.picks.p1);
            renderFinalList(elements.finalP1Bans, state.draft.idBans.p2); 
            renderFinalList(elements.finalP2Picks, state.draft.picks.p2);
            renderFinalList(elements.finalP2Bans, state.draft.idBans.p1);
            renderBannedEgosDisplay();
        }

        function checkPhaseReadiness() {
            if (state.userRole !== 'ref') {
                elements.startEgoBan.disabled = true;
                elements.completeDraft.disabled = true;
                return;
            }

            const { phase, currentPlayer, actionCount } = state.draft;
            if (phase === 'roster') {
                const p1Ready = state.participants.p1?.ready && state.roster.p1.length === ROSTER_SIZE;
                const p2Ready = state.participants.p2?.ready && state.roster.p2.length === ROSTER_SIZE;
                elements.startEgoBan.disabled = !(p1Ready && p2Ready);
            } else {
                elements.startEgoBan.disabled = true;
            }

            elements.completeDraft.disabled = phase === 'complete';
        }
        
        function renderRosterBuilder() {
            if (!state.isDataLoaded) return;
            const filteredList = filterIDs(state.masterIDList, state.filters);
            renderIDList(elements.builderIdPool, filteredList, state.builderRoster, toggleBuilderIdSelection);
            
            const selectedObjects = state.builderRoster.map(id => state.masterIDList.find(item => item.id === id)).filter(Boolean);
            renderIDList(elements.builderSelectedRoster, selectedObjects, state.builderRoster, toggleBuilderIdSelection);

            elements.builderCounter.textContent = state.builderRoster.length;
            
            if(state.builderRoster.length === ROSTER_SIZE) {
                const code = generateRosterCode();
                elements.builderRosterCodeDisplay.textContent = code || "Error generating code.";
                elements.builderCopyCode.disabled = !code;
            } else {
                elements.builderRosterCodeDisplay.textContent = `Select ${ROSTER_SIZE - state.builderRoster.length} more IDs to generate a code.`;
                elements.builderCopyCode.disabled = true;
            }
        }

        // ======================
        // CLIENT ACTIONS & EVENT HANDLERS
        // ======================
        function toggleBuilderIdSelection(id) {
            const index = state.builderRoster.indexOf(id);
            if (index > -1) {
                state.builderRoster.splice(index, 1);
            } else {
                if (state.builderRoster.length < ROSTER_SIZE) {
                    state.builderRoster.push(id);
                } else {
                    showNotification(`You can only select ${ROSTER_SIZE} IDs.`);
                }
            }
            renderRosterBuilder();
        }

        // ======================
        // STATE HANDLERS
        // ======================
        function handleInit(message) {
            state.masterIDList = message.masterIDList;
            state.masterEGOList = message.masterEGOList;
            state.isDataLoaded = true;
            elements.loadingOverlay.classList.add('hidden');
            
            // If we are in the builder, render it now that we have data
            if (state.currentView === 'rosterBuilderPage') {
                renderRosterBuilder();
            }
        }
        
        function handleLobbyCreated(message) {
            state.lobbyCode = message.code;
            state.userRole = 'ref';
            handleStateUpdate(message);
        }
        
        function handleLobbyJoined(message) {
            state.lobbyCode = message.lobbyCode;
            state.userRole = message.role;
            handleStateUpdate(message);
            showNotification(`Joined lobby as ${state.participants[state.userRole].name}`);
        }
        
        function handleStateUpdate(message) {
            state.participants = message.state.participants;
            state.roster = message.state.roster;
            state.draft = message.state.draft;
            elements.lobbyCodeDisplay.textContent = state.lobbyCode;
            updateAllUIsFromState();
        }

        // ======================
        // INITIALIZATION
        // ======================
        function setupFilterBar(barId, filterStateObject) {
            const bar = document.getElementById(barId);
            if (!bar) return;

            const update = () => {
                if (state.currentView === 'lobbyView') {
                    if (state.draft.phase === 'roster') filterAndRenderRosterSelection();
                    else updateDraftInstructions();
                } else if (state.currentView === 'rosterBuilderPage') {
                    renderRosterBuilder();
                }
            };

            bar.addEventListener('input', (e) => {
                if (e.target.classList.contains('roster-search-input')) {
                    filterStateObject.rosterSearch = e.target.value;
                    update();
                }
            });
            bar.addEventListener('change', (e) => {
                const filterType = e.target.dataset.filter;
                if (filterType) {
                    filterStateObject[filterType] = e.target.value;
                    update();
                }
            });
            bar.addEventListener('click', (e) => {
                if (e.target.closest('.reset-filters-btn')) {
                    Object.keys(filterStateObject).forEach(key => filterStateObject[key] = "");
                    bar.querySelectorAll('input, select').forEach(el => el.value = "");
                    update();
                }
            });
        }

        function setupEventListeners() {
            // Main Page
            elements.createLobbyBtn.addEventListener('click', () => sendMessage({ type: 'createLobby', name: elements.playerNameInput.value.trim() || 'Referee' }));
            elements.joinLobbyToggle.addEventListener('click', () => {
                elements.lobbyAccessForm.classList.toggle('hidden');
            });
            elements.goToBuilder.addEventListener('click', () => {
                switchView('rosterBuilderPage');
                // Render builder only if data is already loaded, otherwise handleInit will do it
                if (state.isDataLoaded) {
                    renderRosterBuilder();
                }
            });
            elements.roleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    elements.roleOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            elements.enterLobbyBtn.addEventListener('click', () => {
                const lobbyCode = elements.lobbyCodeInput.value.trim().toUpperCase();
                const selectedRoleEl = document.querySelector('.role-option.selected');
                if (!selectedRoleEl) return showNotification('Please select a role.', true);
                const selectedRole = selectedRoleEl.dataset.role;
                if (!lobbyCode || !selectedRole) return showNotification('Enter code and select a role.', true);
                sendMessage({ type: 'joinLobby', lobbyCode, role: selectedRole, name: elements.playerNameInput.value.trim() || `Player ${selectedRole.replace('p','')}` });
            });
            
            // Back/Restart buttons
            elements.backToMainLobby.addEventListener('click', () => window.location.reload());
            elements.backToMainBuilder.addEventListener('click', () => switchView('mainPage'));
            elements.restartDraft.addEventListener('click', () => window.location.reload());
            
            // Lobby Roster Controls
            ['p1', 'p2'].forEach(player => {
                elements[`${player}Random`].addEventListener('click', () => sendMessage({ type: 'rosterRandomize', lobbyCode: state.lobbyCode, player }));
                elements[`${player}Clear`].addEventListener('click', () => sendMessage({ type: 'rosterSet', lobbyCode: state.lobbyCode, player, roster: [] }));
                elements[`${player}Ready`].addEventListener('click', () => {
                    if (state.roster[player].length !== ROSTER_SIZE && !state.participants[player].ready) return showNotification(`Must select ${ROSTER_SIZE} IDs.`, true);
                    sendMessage({ type: 'updateReady', lobbyCode: state.lobbyCode, player });
                });
                elements[`${player}RosterLoad`].addEventListener('click', () => {
                    const code = elements[`${player}RosterCodeInput`].value.trim();
                    const roster = loadRosterFromCode(code);
                    if (roster) {
                        sendMessage({ type: 'rosterSet', lobbyCode: state.lobbyCode, player, roster });
                        showNotification("Roster loaded successfully!");
                    }
                });
            });
            
            // Roster Builder Controls
            elements.builderRandom.addEventListener('click', () => {
                const shuffled = [...state.masterIDList].sort(() => 0.5 - Math.random());
                state.builderRoster = shuffled.slice(0, ROSTER_SIZE).map(id => id.id);
                renderRosterBuilder();
            });
            elements.builderClear.addEventListener('click', () => {
                state.builderRoster = [];
                renderRosterBuilder();
            });
            elements.builderCopyCode.addEventListener('click', () => {
                const code = elements.builderRosterCodeDisplay.textContent;
                navigator.clipboard.writeText(code).then(() => showNotification("Roster code copied!"), () => showNotification("Failed to copy.", true));
            });
            elements.builderLoadCode.addEventListener('click', () => {
                const code = elements.builderLoadCodeInput.value.trim();
                const roster = loadRosterFromCode(code);
                if (roster) {
                    state.builderRoster = roster;
                    renderRosterBuilder();
                    showNotification("Roster loaded!");
                }
            });

            // EGO Search
            elements.egoSearchInput.addEventListener('input', (e) => {
                state.egoSearch = e.target.value;
                renderEgoBanPhase();
            });

            // Draft controls (Referee only)
            elements.startEgoBan.addEventListener('click', () => sendMessage({ type: 'draftControl', lobbyCode: state.lobbyCode, action: 'startEgoBan' }));
            elements.completeDraft.addEventListener('click', () => sendMessage({ type: 'draftControl', lobbyCode: state.lobbyCode, action: 'complete' }));
        }

        function createFilterBarHTML() {
            return `
                <div class="filter-group" style="flex: 2;">
                    <label class="filter-label">Search by Name:</label>
                    <input type="text" class="roster-search-input" placeholder="e.g. LCB Sinner...">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sinner:</label>
                    <select class="sinner-filter" data-filter="sinner">
                        <option value="">All</option>
                        <option value="Yi Sang">Yi Sang</option><option value="Faust">Faust</option><option value="Don Quixote">Don Quixote</option>
                        <option value="Ryōshū">Ryōshū</option><option value="Meursault">Meursault</option><option value="Hong Lu">Hong Lu</option>
                        <option value="Heathcliff">Heathcliff</option><option value="Ishmael">Ishmael</option><option value="Rodion">Rodion</option>
                        <option value="Sinclair">Sinclair</option><option value="Outis">Outis</option><option value="Gregor">Gregor</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sin:</label>
                    <select class="sinAffinity-filter" data-filter="sinAffinity">
                        <option value="">All</option>
                        <option value="Wrath">Wrath</option><option value="Lust">Lust</option><option value="Sloth">Sloth</option>
                        <option value="Gluttony">Gluttony</option><option value="Gloom">Gloom</option><option value="Pride">Pride</option><option value="Envy">Envy</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Keyword:</label>
                    <select class="keyword-filter" data-filter="keyword">
                        <option value="">All</option>
                        <option value="Sinking">Sinking</option><option value="Rupture">Rupture</option><option value="Discard">Discard</option>
                        <option value="Tremor">Tremor</option><option value="Bleed">Bleed</option><option value="Poise">Poise</option>
                        <option value="Charge">Charge</option><option value="Burn">Burn</option><option value="Ammo">Ammo</option>
                    </select>
                </div>
                <button class="btn btn-secondary reset-filters-btn" title="Reset Filters"><i class="fas fa-sync"></i></button>
            `;
        }

        function cacheDOMElements() {
             elements = {
                // Overlays & Global
                loadingOverlay: document.getElementById('loading-overlay'),
                connectionStatus: document.getElementById('connection-status'),
                notification: document.getElementById('notification'),
                // Pages
                mainPage: document.getElementById('main-page'),
                lobbyView: document.getElementById('lobby-view'),
                rosterBuilderPage: document.getElementById('roster-builder-page'),
                completedView: document.getElementById('completed-view'),
                // Main Page
                lobbyAccessForm: document.getElementById('lobby-access-form'),
                createLobbyBtn: document.getElementById('create-lobby'),
                joinLobbyToggle: document.getElementById('join-lobby-toggle'),
                goToBuilder: document.getElementById('go-to-builder'),
                enterLobbyBtn: document.getElementById('enter-lobby'),
                lobbyCodeInput: document.getElementById('lobby-code'),
                roleOptions: document.querySelectorAll('.role-option'),
                playerNameInput: document.getElementById('player-name'),
                // Shared
                backToMainLobby: document.getElementById('back-to-main-lobby'),
                backToMainBuilder: document.getElementById('back-to-main-builder'),
                restartDraft: document.getElementById('restart-draft'), 
                // Lobby
                lobbyCodeDisplay: document.getElementById('lobby-code-display'),
                participantsList: document.getElementById('participants-list'),
                draftStatusPanel: document.getElementById('draft-status-panel'),
                currentPhase: document.getElementById('current-phase'),
                draftActionDescription: document.getElementById('draft-action-description'),
                // Roster Phase (Lobby)
                rosterPhase: document.getElementById('roster-phase'),
                p1Panel: document.getElementById('p1-panel'), p2Panel: document.getElementById('p2-panel'),
                p1Roster: document.getElementById('p1-roster'), p2Roster: document.getElementById('p2-roster'),
                p1Counter: document.getElementById('p1-counter'), p2Counter: document.getElementById('p2-counter'),
                p1Random: document.getElementById('p1-random'), p2Random: document.getElementById('p2-random'),
                p1Clear: document.getElementById('p1-clear'), p2Clear: document.getElementById('p2-clear'),
                p1Ready: document.getElementById('p1-ready'), p2Ready: document.getElementById('p2-ready'),
                p1Status: document.getElementById('p1-status'), p2Status: document.getElementById('p2-status'),
                p1NameDisplay: document.getElementById('p1-name-display'), p2NameDisplay: document.getElementById('p2-name-display'),
                p1RosterCodeInput: document.getElementById('p1-roster-code-input'), p2RosterCodeInput: document.getElementById('p2-roster-code-input'),
                p1RosterLoad: document.getElementById('p1-roster-load'), p2RosterLoad: document.getElementById('p2-roster-load'),
                startEgoBan: document.getElementById('start-ego-ban'),
                // Roster Builder
                builderIdPool: document.getElementById('builder-id-pool'),
                builderSelectedRoster: document.getElementById('builder-selected-roster'),
                builderCounter: document.getElementById('builder-counter'),
                builderRandom: document.getElementById('builder-random'),
                builderClear: document.getElementById('builder-clear'),
                builderRosterCodeDisplay: document.getElementById('builder-roster-code-display'),
                builderCopyCode: document.getElementById('builder-copy-code'),
                builderLoadCodeInput: document.getElementById('builder-load-code-input'),
                builderLoadCode: document.getElementById('builder-load-code'),
                // EGO Ban Phase
                egoBanPhase: document.getElementById('ego-ban-phase'),
                egoSearchInput: document.getElementById('ego-search-input'),
                egoBanContainer: document.getElementById('ego-ban-container'),
                opponentRosterDisplay: document.getElementById('opponent-roster-display'),
                opponentRosterTitle: document.getElementById('opponent-roster-title'),
                opponentRosterList: document.getElementById('opponent-roster-list'),
                // ID Draft Phase
                idDraftPhase: document.getElementById('id-draft-phase'),
                draftBannedEgosList: document.getElementById('draft-banned-egos-list'),
                completeDraft: document.getElementById('complete-draft'),
                p1DraftPanel: document.getElementById('p1-draft-panel'), p2DraftPanel: document.getElementById('p2-draft-panel'),
                p1DraftName: document.getElementById('p1-draft-name'), p2DraftName: document.getElementById('p2-draft-name'),
                p1DraftStatus: document.getElementById('p1-draft-status'), p2DraftStatus: document.getElementById('p2-draft-status'),
                p1DraftSelection: document.getElementById('p1-draft-selection'), p2DraftSelection: document.getElementById('p2-draft-selection'),
                p1IdBans: document.getElementById('p1-id-bans'), p2IdBans: document.getElementById('p2-id-bans'),
                p1Picks: document.getElementById('p1-picks'), p2Picks: document.getElementById('p2-picks'),
                // Completed View
                finalBannedEgosList: document.getElementById('final-banned-egos-list'),
                finalP1Name: document.getElementById('final-p1-name'), finalP2Name: document.getElementById('final-p2-name'),
                finalP1Picks: document.getElementById('final-p1-picks'), finalP1Bans: document.getElementById('final-p1-bans'),   
                finalP2Picks: document.getElementById('final-p2-picks'), finalP2Bans: document.getElementById('final-p2-bans'),
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            cacheDOMElements();

            // Inject filter bars HTML
            document.getElementById('global-filter-bar-roster').innerHTML = createFilterBarHTML();
            document.getElementById('global-filter-bar-builder').innerHTML = createFilterBarHTML();
            document.getElementById('global-filter-bar-draft').innerHTML = createFilterBarHTML();
            
            // Setup ALL event listeners on load, so the UI is immediately interactive.
            setupEventListeners();
            
            // Setup filter bar event listeners
            setupFilterBar('global-filter-bar-roster', state.filters);
            setupFilterBar('global-filter-bar-builder', state.filters);
            setupFilterBar('global-filter-bar-draft', state.draftFilters);

            // Connect to server, which will trigger the init flow for loading data
            connectWebSocket();
        });
    </script>
</body>
</html>
